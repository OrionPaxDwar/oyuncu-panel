<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dwar Etkinlik Merkezi - Y√∂netim Paneli</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- OTP Library for 2FA -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/otpauth/9.1.4/otpauth.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;700;900&display=swap');
        
        body {
            background: #0f172a;
            color: #f8fafc;
            font-family: 'Rajdhani', sans-serif;
            overflow: hidden;
            height: 100vh;
            margin: 0;
        }

        .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* --- LOGIN EKRANI STƒ∞LLERƒ∞ --- */
        #login-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: #0f172a;
            background-image: radial-gradient(circle at center, #1e293b 0%, #0f172a 100%);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }

        .login-card {
            background: rgba(30, 41, 59, 0.8);
            backdrop-filter: blur(20px);
            padding: 3rem;
            border-radius: 2rem;
            border: 1px solid rgba(56, 189, 248, 0.3);
            box-shadow: 0 0 50px rgba(56, 189, 248, 0.15);
            width: 100%;
            max-width: 400px;
            text-align: center;
            transition: all 0.5s ease;
        }

        .login-input {
            width: 100%;
            background: #0f172a;
            border: 1px solid rgba(255,255,255,0.1);
            padding: 1rem;
            border-radius: 1rem;
            color: white;
            margin-bottom: 1rem;
            outline: none;
            transition: all 0.3s;
            font-family: 'Rajdhani', sans-serif;
            font-weight: bold;
            letter-spacing: 1px;
            text-align: center;
        }

        .login-input::placeholder { text-align: center; color: #64748b; }
        
        .login-input:focus {
            border-color: #38bdf8;
            box-shadow: 0 0 15px rgba(56, 189, 248, 0.2);
        }

        .login-btn {
            width: 100%;
            background: linear-gradient(135deg, #0ea5e9, #2563eb);
            padding: 1rem;
            border-radius: 1rem;
            color: white;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 2px;
            transition: all 0.3s;
            box-shadow: 0 10px 20px rgba(14, 165, 233, 0.3);
            cursor: pointer;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 30px rgba(14, 165, 233, 0.4);
        }

        .otp-input {
            letter-spacing: 10px;
            font-size: 24px;
            color: #fbbf24;
        }

        /* --- MEVCUT ORTAK STƒ∞LLER --- */
        .mirror-wrapper { perspective: 1000px; width: 100%; aspect-ratio: 1/1; }
        .mirror-card { width: 100%; height: 100%; position: relative; transform-style: preserve-3d; transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1); cursor: pointer; }
        .mirror-card.flipped { transform: rotateY(180deg); }
        .mirror-front, .mirror-back { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; border-radius: 12px; display: flex; align-items: center; justify-content: center; border: 2px solid rgba(255,255,255,0.1); }
        .mirror-front { background: linear-gradient(135deg, #94a3b8 0%, #cbd5e1 50%, #94a3b8 100%); box-shadow: inset 0 0 20px rgba(255,255,255,0.5); color: #1e293b; font-size: 1.5rem; font-weight: 900; }
        .mirror-back { background: #1e293b; transform: rotateY(180deg); font-size: 2.2rem; font-weight: 900; }
        .val-5 { color: #facc15; text-shadow: 0 0 10px rgba(250, 204, 21, 0.5); }
        .val-2 { color: #94a3b8; text-shadow: 0 0 10px rgba(148, 163, 184, 0.5); }
        .val-1 { color: #b45309; text-shadow: 0 0 10px rgba(180, 83, 9, 0.5); }
        .selected-mirror { box-shadow: 0 0 25px #fbbf24; border: 3px solid #fbbf24 !important; z-index: 10; }
        
        .pyramid-item { padding: 6px 15px; background: rgba(30, 41, 59, 0.5); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 6px; font-size: 11px; color: #94a3b8; width: 100%; display: flex; justify-content: space-between; transition: all 0.3s; }
        .pyramid-item.highlight { background: #fbbf24; color: #000; border-color: #fff; transform: scale(1.05); font-weight: 900; box-shadow: 0 0 20px #fbbf24; }

        .box-item { position: relative; perspective: 1000px; cursor: pointer; width: 100%; max-width: 110px; aspect-ratio: 1 / 1; }
        .box-inner { position: relative; width: 100%; height: 100%; transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1); transform-style: preserve-3d; background: linear-gradient(135deg, rgba(30, 41, 59, 0.8), rgba(15, 23, 42, 0.9)); border-radius: 12px; border: 1px solid rgba(255, 255, 255, 0.05); display: flex; align-items: center; justify-content: center; }
        .box-item.opened .box-inner { transform: rotateY(180deg); background: rgba(15, 23, 42, 0.95); }
        .box-front, .box-back { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; display: flex; align-items: center; justify-content: center; border-radius: 12px; }
        .box-back { transform: rotateY(180deg); background: rgba(56, 189, 248, 0.1); border: 2px solid rgba(56, 189, 248, 0.3); flex-direction: column; text-align: center; overflow: hidden; }
        .box-number-badge { position: absolute; top: 0; left: 0; background: rgba(56, 189, 248, 0.4); color: #ffffff; padding: 2px 8px; font-size: 18px; font-weight: 900; border-bottom-right-radius: 10px; z-index: 10; }
        .box-icon { font-size: 3.5rem; user-select: none; }
        
        .wheel-container { position: relative; perspective: 1200px; filter: drop-shadow(0 20px 50px rgba(0, 0, 0, 0.5)); transform: scale(0.85); }
        .wheel-3d-wrapper { transform: rotateX(15deg); transform-style: preserve-3d; transition: transform 0.5s ease; }
        .wheel-canvas { border: 12px solid #1e293b; border-radius: 50%; background: #0f172a; box-shadow: 0 10px 0 #0a0f1d; }
        .wheel-pointer { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); width: 40px; height: 50px; background: #ef4444; clip-path: polygon(50% 100%, 0% 0%, 100% 0%); z-index: 100; filter: drop-shadow(0 5px 5px rgba(0,0,0,0.5)); border: 2px solid white; }
        
        .dice-container { width: 80px; height: 80px; background: #ffffff; border-radius: 14px; display: grid; grid-template-columns: repeat(3, 1fr); grid-template-rows: repeat(3, 1fr); padding: 8px; gap: 4px; box-shadow: inset 0 4px 8px rgba(0,0,0,0.1), inset 0 -4px 8px rgba(0,0,0,0.1), 0 10px 20px rgba(0,0,0,0.4); position: relative; border: 1px solid #ddd; transition: transform 0.1s linear; }
        .dice-dot { background: #1e293b; border-radius: 50%; width: 14px; height: 14px; margin: auto; box-shadow: inset 0 2px 2px rgba(255,255,255,0.2); }
        .dice-rolling { animation: dice-tumble 0.4s infinite linear; }
        @keyframes dice-tumble { 0% { transform: rotate(0deg) scale(1); } 25% { transform: rotate(90deg) scale(1.1); } 50% { transform: rotate(180deg) scale(0.9); } 75% { transform: rotate(270deg) scale(1.1); } 100% { transform: rotate(360deg) scale(1); } }
        
        .marquee-container { position: fixed; bottom: 0; left: 0; width: 100%; background: rgba(15, 23, 42, 0.95); border-top: 2px solid rgba(56, 189, 248, 0.4); height: 45px; display: flex; align-items: center; overflow: hidden; z-index: 100; }
        .marquee-content { display: flex; white-space: nowrap; animation: marquee-scroll 40s linear infinite; gap: 50px; }
        @keyframes marquee-scroll { 0% { transform: translateX(100%); } 100% { transform: translateX(-100%); } }
        
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
        .tab-btn.active { background: #38bdf8; color: #0f172a; }
        .hidden-page { display: none !important; }
        
        .lucky-ball { width: 80px; height: 80px; background: radial-gradient(circle at 30% 30%, #facc15, #854d0e); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2.5rem; font-weight: 900; color: white; box-shadow: 0 10px 20px rgba(0,0,0,0.4); border: 2px solid rgba(255,255,255,0.2); transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .ball-spinning { animation: lucky-spin 0.3s infinite linear; }
        @keyframes lucky-spin { 0% { transform: rotate(0deg) translateY(-5px); } 50% { transform: rotate(180deg) translateY(5px); } 100% { transform: rotate(360deg) translateY(-5px); } }
        
        .jackpot-counter { background: linear-gradient(to bottom, #451a03, #1e1b4b); border: 2px solid #facc15; }
        .user-winner { border-left: 4px solid #10b981 !important; background: rgba(16, 185, 129, 0.1) !important; }

        .lucky-winners-list {
            max-height: 200px;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: #334155 transparent;
        }
        .lucky-winners-list::-webkit-scrollbar { width: 4px; }
        .lucky-winners-list::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }

        .rules-modal, .bulk-modal, .stats-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(8px); z-index: 200; display: none; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s ease; }
        .rules-modal.active, .bulk-modal.active, .stats-modal.active { display: flex; opacity: 1; }
        .rules-content, .bulk-content, .stats-content { background: #1e293b; border: 2px solid rgba(56, 189, 248, 0.3); padding: 2rem; border-radius: 1.5rem; max-width: 500px; width: 90%; position: relative; box-shadow: 0 0 50px rgba(56, 189, 248, 0.15); transform: scale(0.9); transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .rules-modal.active .rules-content, .bulk-modal.active .bulk-content, .stats-modal.active .stats-content { transform: scale(1); }
        .rules-close { position: absolute; top: 1rem; right: 1rem; background: rgba(255, 255, 255, 0.1); width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; color: #94a3b8; transition: all 0.2s; }
        .rules-close:hover { background: #ef4444; color: white; }
        .bulk-content { border-color: rgba(245, 158, 11, 0.3); }
        .stats-content { border-color: rgba(16, 185, 129, 0.3); max-width: 600px; }

        .ticket-ball {
            width: 70px; height: 70px;
            background: radial-gradient(circle at 30% 30%, #fef3c7, #d97706);
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 40px; font-weight: 900; color: #78350f;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5), inset 0 2px 5px rgba(255,255,255,0.5);
            border: 2px solid #fff;
            transform: scale(0);
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .ticket-ball.active { transform: scale(1); }

        #confetti-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9999; }
        
        .raffle-luxury-card {
            background: linear-gradient(160deg, #18181b 0%, #000000 100%);
            border: 1px solid #d97706;
            border-radius: 12px;
            padding: 16px;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            gap: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.6), inset 0 0 0 1px rgba(217, 119, 6, 0.2);
            animation: card-flip-in 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
            opacity: 0;
            transform-style: preserve-3d;
            perspective: 1000px;
        }

        .raffle-luxury-card::after {
            content: '';
            position: absolute;
            top: 0; right: 0;
            width: 40px; height: 40px;
            background: linear-gradient(135deg, transparent 50%, #d97706 50%);
            opacity: 0.3;
        }
        
        .raffle-luxury-card .shimmer-layer {
            position: absolute;
            top: 0; left: -150%;
            width: 100%; height: 100%;
            background: linear-gradient(to right, transparent, rgba(251, 191, 36, 0.15), transparent);
            transform: skewX(-20deg);
            animation: shimmer-move 3s infinite;
            pointer-events: none;
        }

        .raffle-rank-badge {
            width: 48px; height: 48px;
            background: linear-gradient(135deg, #f59e0b, #b45309);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: 900;
            color: #fff;
            box-shadow: 0 4px 10px rgba(245, 158, 11, 0.4);
            border: 2px solid #fff;
            transform: rotate(-5deg);
        }

        .raffle-info { flex: 1; z-index: 2; }
        .raffle-info h4 { font-size: 9px; color: #fbbf24; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 2px; }
        .raffle-info .winner-name { font-size: 22px; font-weight: 900; color: #fff; line-height: 1; text-shadow: 0 2px 10px rgba(0,0,0,0.5); }
        .raffle-info .reward-tag { font-size: 11px; color: #94a3b8; font-weight: 700; margin-top: 4px; display: flex; align-items: center; gap: 4px; }
        .raffle-info .reward-tag span { color: #38bdf8; }

        @keyframes card-flip-in {
            0% { opacity: 0; transform: rotateX(-90deg) translateY(50px) scale(0.8); }
            60% { transform: rotateX(10deg) translateY(-5px) scale(1.02); }
            100% { opacity: 1; transform: rotateX(0deg) translateY(0) scale(1); }
        }

        @keyframes shimmer-move {
            0% { left: -150%; }
            40% { left: 150%; }
            100% { left: 150%; }
        }
        
        .pulse-btn { animation: pulse-orange 2s infinite; }
        @keyframes pulse-orange {
            0% { box-shadow: 0 0 0 0 rgba(249, 115, 22, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(249, 115, 22, 0); }
            100% { box-shadow: 0 0 0 0 rgba(249, 115, 22, 0); }
        }

        .pool-item {
            background: rgba(30, 41, 59, 0.6);
            border: 1px solid rgba(255,255,255,0.05);
            border-radius: 8px;
            padding: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.2s;
        }
        .pool-item:hover {
            background: rgba(30, 41, 59, 0.9);
            border-color: rgba(56, 189, 248, 0.3);
        }
        .pool-img {
            width: 40px; height: 40px;
            border-radius: 6px;
            object-fit: cover;
            background: #0f172a;
        }

        .stats-table-row {
            display: grid;
            grid-template-columns: 50px 2fr 100px 1fr 1fr 50px;
            gap: 10px;
            padding: 12px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            align-items: center;
            transition: background 0.2s;
        }
        .stats-table-row:hover {
            background: rgba(255,255,255,0.05);
            cursor: pointer;
        }
        .stats-header {
            background: rgba(15, 23, 42, 0.8);
            font-weight: bold;
            color: #94a3b8;
            font-size: 11px;
            text-transform: uppercase;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .hidden { display: none !important; }
    </style>
</head>
<body>
    <canvas id="confetti-canvas"></canvas>

    <!-- Gƒ∞Rƒ∞≈û EKRANI (LOGIN SCREEN) - REVƒ∞ZE EDƒ∞LDƒ∞ -->
    <div id="login-overlay">
        <div class="login-card">
            <img src="https://dwar.gen.tr/images/dragon_logo.png" alt="Logo" class="w-24 h-24 mx-auto mb-6 object-contain filter drop-shadow-[0_0_15px_rgba(56,189,248,0.8)]">
            <h2 class="text-2xl font-black text-white uppercase tracking-widest mb-1 italic">Y√ñNETƒ∞M Gƒ∞Rƒ∞≈ûƒ∞</h2>
            <p class="text-xs text-slate-400 mb-8 uppercase font-bold tracking-wider">Yetkili personel i√ßin korumalƒ± alan</p>
            
            <!-- STEP 1: Kullanƒ±cƒ± Adƒ± / ≈ûifre -->
            <form id="login-step-1" onsubmit="event.preventDefault(); initiateLogin();">
                <input type="text" id="login-user" class="login-input" placeholder="KULLANICI ADI" autocomplete="off">
                <input type="password" id="login-pass" class="login-input" placeholder="≈ûƒ∞FRE">
                <button type="submit" class="login-btn">DEVAM ET ‚û°Ô∏è</button>
            </form>

            <!-- STEP 2: 2FA (Authenticator) -->
            <form id="login-step-2" class="hidden" onsubmit="event.preventDefault(); verify2FA();">
                <p class="text-yellow-400 text-xs font-bold mb-4 uppercase">üîê AUTHENTICATOR KODU Gƒ∞Rƒ∞N</p>
                <input type="text" id="otp-code" class="login-input otp-input" placeholder="000 000" maxlength="6" autocomplete="one-time-code" inputmode="numeric">
                <button type="submit" class="login-btn bg-emerald-600">DOƒûRULA VE Gƒ∞Rƒ∞≈û YAP ‚úÖ</button>
                <button type="button" onclick="backToStep1()" class="text-slate-500 text-[10px] mt-4 hover:text-white underline">Geri D√∂n</button>
            </form>

            <p id="login-error" class="text-rose-500 text-xs mt-4 font-bold hidden uppercase bg-rose-900/20 p-2 rounded">Hatalƒ± Bilgi!</p>
        </div>
    </div>

    <!-- ANA UYGULAMA (Gƒ∞ZLƒ∞ BA≈ûLAR) -->
    <div id="app-container" class="h-full flex flex-col p-4 pb-16 hidden">

        <!-- Firebase SDK Imports -->
        <script type="module">

            import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
            import { getAuth, signInAnonymously } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
            import { getFirestore, collection, doc, setDoc, getDoc, addDoc, deleteDoc, onSnapshot, query, where, getDocs, orderBy, limit, writeBatch, increment, arrayUnion } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

            const appId = "default";

            const firebaseConfig = {
            apiKey: "AIzaSyA4yI7eN3DF-Kt4HSuwt6hpZzI4Z8s2PN0",
            authDomain: "dwar-etkinlik-merkezi-15d51.firebaseapp.com",
            projectId: "dwar-etkinlik-merkezi-15d51",
            storageBucket: "dwar-etkinlik-merkezi-15d51.firebasestorage.app",
            messagingSenderId: "262902378690",
            appId: "1:262902378690:web:76a68a16e0d9e6c5e44b5b"
            };

            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);

            // Global State for Firestore
            let activeGameDetails = null;
            let currentUser = null;

            // --- AUTH (Anonymous) ---
            window.startFirebase = function() {
                signInAnonymously(auth).then((userCredential) => {
                    currentUser = userCredential.user;
                    console.log("Firebase Auth Success:", currentUser.uid);
                    listenToGameState();
                    loadPoolFromFirestore(); 
                    listenToStats(); // Start listening to stats
                }).catch((error) => {
                    console.error("Auth Failed:", error);
                });
            }

            // --- FIRESTORE LISTENERS ---

            function listenToGameState() {
                const gameStateRef = doc(db, "artifacts/default/public/data/active/state")
                
                onSnapshot(gameStateRef, (docSnap) => {
                    if (docSnap.exists()) {
                        activeGameDetails = docSnap.data();
                         listenToEntries(activeGameDetails.game, activeGameDetails.round);
                    } else {
                        console.log("No active game state found.");
                    }
                });
            }

            let unsubscribeEntries = null;
            function listenToEntries(gameType, roundId) {
                if (unsubscribeEntries) unsubscribeEntries();

                const entriesRef = collection(db, 'artifacts', appId, 'public', 'data', 'entries');
                const q = query(entriesRef, where('game', '==', gameType), where('round', '==', roundId));

                unsubscribeEntries = onSnapshot(q, (snapshot) => {
                    const entries = [];
                    const seenNicks = new Set();

                    snapshot.forEach((doc) => {
                        const data = doc.data();
                        const normalizedNick = data.nick.trim().toLocaleLowerCase('tr');
                        
                        if (!seenNicks.has(normalizedNick)) {
                            seenNicks.add(normalizedNick);
                            entries.push({ id: doc.id, ...data });
                        }
                    });

                    if (gameType === 'game') { 
                        window.state.users = entries.map(e => ({ id: e.id, name: e.nick, race: e.race }));
                        window.updateUserList();
                    } else if (gameType === 'wheel') {
                        window.state.wheelUsers = entries.map(e => ({ id: e.id, name: e.nick, race: e.race }));
                        window.updateWheelUserList();
                    } else if (gameType === 'lucky') {
                        window.state.luckyUsers = entries.map(e => ({ 
                            id: e.id, 
                            name: e.nick, 
                            race: e.race,
                            numbers: e.prediction ? e.prediction.split('-').map(Number) : [0,0,0] 
                        }));
                        window.updateLuckyUserList();
                    } else if (gameType === 'dice') {
                        window.state.diceUsers = entries.map(e => ({ 
                            id: e.id, 
                            name: e.nick,
                            race: e.race,
                            target: parseInt(e.prediction) || 0
                        }));
                        window.updateDiceUserList();
                    } else if (gameType === 'mirror') {
                        window.state.mirrorUsers = entries.map(e => ({ id: e.id, name: e.nick, race: e.race }));
                        window.updateMirrorUserList();
                    } else if (gameType === 'raffle') {
                        window.state.raffleUsers = entries.map(e => ({ id: e.id, name: e.nick, race: e.race }));
                        window.updateRaffleUserList();
                    } else if (gameType === 'ticket') {
                        window.state.ticketUsers = entries.map(e => ({ 
                            id: e.id, 
                            name: e.nick,
                            race: e.race,
                            ticketNumber: e.prediction || Math.floor(10000 + Math.random() * 90000).toString()
                        }));
                        window.updateTicketUserList();
                    }
                });
            }

            // --- STATS SYSTEM ---
            
            function listenToStats() {
                const statsRef = collection(db, 'artifacts', appId, 'public', 'data', 'player_stats');
                
                onSnapshot(statsRef, (snapshot) => {
                    window.state.allStats = [];
                    snapshot.forEach((doc) => {
                        window.state.allStats.push({ id: doc.id, ...doc.data() });
                    });
                    window.renderStatsTable();
                });
            }

            window.updateStatInFirestore = async (nick, isWin, winDetails, race) => {
                if(!currentUser) return;
                const normalizedNick = nick.trim().toLocaleLowerCase('tr');
                const userRef = doc(db, 'artifacts', appId, 'public', 'data', 'player_stats', normalizedNick);

                const dataToUpdate = {
                    nick: nick, 
                    lastSeen: new Date().toISOString()
                };

                if(race) {
                    dataToUpdate.race = race;
                }

                if (isWin) {
                    dataToUpdate.winCount = increment(1);
                    dataToUpdate.history = arrayUnion({
                        game: winDetails.game,
                        reward: winDetails.reward,
                        detail: winDetails.detail || '',
                        date: new Date().toISOString()
                    });
                }

                try {
                    await setDoc(userRef, dataToUpdate, { merge: true });
                } catch(e) {
                    console.error("Stats update error:", e);
                }
            };

            window.batchUpdateParticipation = async (userList) => {
                if(!currentUser || !userList || userList.length === 0) return;
                
                const batch = writeBatch(db);
                userList.forEach(u => {
                    const nick = u.name || u.nick;
                    const race = u.race || null; 
                    const normalizedNick = nick.trim().toLocaleLowerCase('tr');
                    const userRef = doc(db, 'artifacts', appId, 'public', 'data', 'player_stats', normalizedNick);
                    
                    const updateData = {
                        nick: nick,
                        participationCount: increment(1),
                        lastSeen: new Date().toISOString()
                    };

                    if (race) {
                        updateData.race = race;
                    }

                    batch.set(userRef, updateData, { merge: true });
                });

                try {
                    await batch.commit();
                    console.log(`Updated participation for ${userList.length} users.`);
                } catch(e) {
                    console.error("Batch participation error:", e);
                }
            };

            window.deleteStat = async (statId, e) => {
                e.stopPropagation(); 
                if(!confirm("Bu oyuncunun istatistiklerini silmek istediƒüinize emin misiniz?")) return;
                try {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'player_stats', statId));
                } catch(e) {
                    alert("Silme hatasƒ±: " + e.message);
                }
            }

            window.updateFirestoreGameState = async (gameType, status) => {
                if (!currentUser) return;
                let roundId;
                if (activeGameDetails && activeGameDetails.game === gameType) {
                    roundId = activeGameDetails.round;
                } else {
                    roundId = Date.now();
                }
                try {
                    await setDoc(doc(db, "artifacts", "default", "public", "data", "active", "state"), {
                        game: gameType,
                        status: status,
                        round: roundId,
                        updatedAt: new Date().toISOString()
                    });
                } catch (e) { console.error("Game State Update Error:", e); alert("Oyun durumu g√ºncellenemedi!"); }
            };

            window.clearFirestoreCollection = async (gameType) => {
                 if (!confirm(`${gameType.toUpperCase()} i√ßin kayƒ±tlƒ± kullanƒ±cƒ± listesini silmek istediƒüinize emin misiniz?`)) return;
                 if (!activeGameDetails) return;
                 const currentRound = activeGameDetails.round;
                 const entriesRef = collection(db, 'artifacts', appId, 'public', 'data', 'entries');
                 const q = query(entriesRef, where('game', '==', gameType), where('round', '==', currentRound));
                 const snapshot = await getDocs(q);
                 const batch = writeBatch(db);
                 snapshot.forEach((doc) => { batch.delete(doc.ref); });
                 await batch.commit();
                 alert("Liste veritabanƒ±ndan temizlendi.");
            };

            window.fullSystemReset = async () => {
                 window.state.users = []; window.state.eliminatedUsers = [];
                 window.state.wheelUsers = []; window.state.eliminatedWheelUsers = [];
                 window.state.luckyUsers = []; window.state.luckyResult = [0,0,0];
                 window.state.diceUsers = []; window.state.diceSum = 0;
                 window.state.mirrorUsers = []; window.state.eliminatedMirrorUsers = [];
                 window.state.raffleUsers = []; window.state.eliminatedRaffleUsers = [];
                 window.state.ticketUsers = []; window.state.ticketWinner = null;
                 window.state.winners = [];
                 window.updateUserList(); window.updateWheelUserList(); window.updateLuckyUserList(); window.updateDiceUserList();
                 window.updateMirrorUserList(); window.updateRaffleUserList(); window.updateTicketUserList();
                 document.getElementById('winners-log-large').innerHTML = '';
                 if (activeGameDetails) {
                     const entriesRef = collection(db, 'artifacts', appId, 'public', 'data', 'entries');
                     const q = query(entriesRef, where('round', '==', activeGameDetails.round));
                     const snapshot = await getDocs(q);
                     const batch = writeBatch(db);
                     snapshot.forEach((doc) => batch.delete(doc.ref));
                     await batch.commit();
                 }
                 alert("Sistem ve veritabanƒ± temizlendi.");
            }

            window.savePoolToFirestore = async () => {
                if(!currentUser) return;
                try {
                    await setDoc(doc(db, "artifacts", "default", "public", "data", "config", "pool"), { rewards: window.state.rewardPool });
                } catch(e) { console.error("Havuz kayƒ±t hatasƒ±:", e); }
            }

            window.loadPoolFromFirestore = async () => {
                if(!currentUser) return;
                const ref = doc(db, "artifacts", "default", "public", "data", "config", "pool");
                try {
                    const snap = await getDoc(ref);
                    if(snap.exists()) {
                        window.state.rewardPool = snap.data().rewards || [];
                        window.renderRewardPool();
                    }
                } catch(e) { console.error("Havuz y√ºkleme hatasƒ±:", e); }
            }

        </script>

        <!-- Header -->
        <header class="flex justify-between items-center mb-4 glass-panel p-4 rounded-2xl">
            <div class="flex items-center gap-4">
                <img src="https://dwar.gen.tr/images/dragon_logo.png" alt="Dwar Logo" class="w-14 h-14 object-contain filter drop-shadow-[0_0_8px_rgba(56,189,248,0.5)]">
                <div>
                    <h1 class="text-xl font-bold tracking-widest uppercase italic leading-none text-blue-450">DWAR ETKƒ∞NLƒ∞K MERKEZƒ∞</h1>
                </div>
            </div>

            <div class="flex bg-slate-900 p-1 rounded-xl border border-white/5 mx-4 overflow-x-auto custom-scrollbar">
                <button id="tab-game" onclick="switchTab('game')" class="tab-btn active px-4 py-2 rounded-lg text-[12px] font-bold uppercase transition shrink-0">KUTU OYUNUüéÅ </button>
                <button id="tab-mirror" onclick="switchTab('mirror')" class="tab-btn px-4 py-2 rounded-lg text-[12px] font-bold uppercase transition shrink-0">AYNA OYUNU ü™û</button>
                <button id="tab-wheel" onclick="switchTab('wheel')" class="tab-btn px-4 py-2 rounded-lg text-[12px] font-bold uppercase transition shrink-0">≈ûANSLI √áARKüõû</button>
                <button id="tab-raffle" onclick="switchTab('raffle')" class="tab-btn px-4 py-2 rounded-lg text-[12px] font-bold uppercase transition shrink-0 text-orange-400">KLASƒ∞K √áEKƒ∞Lƒ∞≈û üî•</button>
                <button id="tab-ticket" onclick="switchTab('ticket')" class="tab-btn px-4 py-2 rounded-lg text-[12px] font-bold uppercase transition shrink-0 text-amber-300">Bƒ∞LET OYUNU üé´</button>
                <button id="tab-lucky" onclick="switchTab('lucky')" class="tab-btn px-4 py-2 rounded-lg text-[12px] font-bold uppercase transition shrink-0">≈ûANS TOPUüé°</button>
                <button id="tab-dice" onclick="switchTab('dice')" class="tab-btn px-4 py-2 rounded-lg text-[12px] font-bold uppercase transition shrink-0">ZAR OYUNU üé≤</button>
                <button id="tab-winners" onclick="switchTab('winners')" class="tab-btn px-4 py-2 rounded-lg text-[12px] font-bold uppercase transition shrink-0">AR≈ûƒ∞Vüìñ</button>
                <button id="tab-stats" onclick="switchTab('stats')" class="tab-btn px-4 py-2 rounded-lg text-[12px] font-bold uppercase transition shrink-0 text-emerald-400">ƒ∞STATƒ∞STƒ∞K üìä</button>
                <button id="tab-config" onclick="switchTab('config')" class="tab-btn px-4 py-2 rounded-lg text-[12px] font-bold uppercase transition shrink-0 text-yellow-500">AYARLAR ‚öôÔ∏è</button>
            </div>

            <div class="flex items-center gap-2">
                <button onclick="confirmReset()" class="bg-rose-900/40 hover:bg-rose-600 text-rose-400 hover:text-white text-[9px] font-black px-3 py-2 rounded-lg transition uppercase border border-rose-500/20">SIFIRLA</button>
            </div>
        </header>

        <!-- Kutu Oyun Sayfasƒ± -->
        <main id="game-page" class="flex-1 grid grid-cols-1 lg:grid-cols-12 gap-4 overflow-hidden">
            <aside class="lg:col-span-3 glass-panel rounded-2xl p-4 flex flex-col overflow-hidden">
                <div class="flex justify-between items-center mb-3">
                    <h2 class="font-bold text-xs uppercase text-slate-400 italic">KUTU KATILIMCILARI</h2>
                    <span id="user-count" class="text-sky-400 text-xs font-mono">0</span>
                </div>
                <div id="user-list" class="flex-1 overflow-y-auto space-y-1.5 pr-2 custom-scrollbar"></div>
                <div class="mt-4 pt-4 border-t border-white/5 space-y-2">
                    <button id="start-btn" onclick="toggleJoin(true)" class="w-full bg-emerald-600 hover:bg-emerald-500 text-white font-black py-3 rounded-lg transition uppercase text-[10px]">KATILIMI A√á</button>
                    <button id="stop-btn" onclick="toggleJoin(false)" class="hidden w-full bg-rose-600 hover:bg-rose-500 text-white font-black py-3 rounded-lg transition uppercase text-[10px]">KATILIMI KAPAT</button>
                    
                    <button onclick="window.clearFirestoreCollection('game')" class="w-full bg-slate-700 hover:bg-rose-900 text-slate-400 hover:text-white font-black py-3 rounded-lg transition uppercase border border-white/10 text-[10px]">Lƒ∞STEYƒ∞ TEMƒ∞ZLE</button>

                    <button id="raffle-btn" onclick="startRaffle()" class="w-full bg-sky-500 hover:bg-sky-400 text-slate-900 font-bold py-4 rounded-xl transition uppercase text-xs mt-2">OYUNCU SE√á</button>
                    <button onclick="showRules('game')" class="w-full text-[20px] bg-slate-700/50 hover:bg-slate-700 text-slate-300 py-2 rounded border border-white/10 uppercase font-bold mt-2">‚ùì Nasƒ±l Oynanƒ±r?</button>
                </div>
            </aside>
            <section class="lg:col-span-9 glass-panel rounded-2xl p-4 flex flex-col relative overflow-hidden">
                <div id="winner-banner" class="mb-4 text-center opacity-0 transition-all transform -translate-y-4">
                    <h3 class="text-sky-400 text-[10px] font-bold tracking-widest uppercase mb-1">≈ûANSLI OYUNCU</h3>
                    <div id="winner-name" class="text-3xl font-black text-white italic tracking-tighter">-</div>
                </div>
                <div id="box-grid" class="flex-1 overflow-y-auto pr-1 custom-scrollbar"></div>
                <div id="post-box-controls" class="absolute bottom-10 left-0 right-0 flex justify-center opacity-0 pointer-events-none transition-all">
                    <button onclick="nextRound()" class="bg-emerald-500 text-slate-900 px-12 py-4 rounded-full font-black uppercase text-sm">TAMAMLA</button>
                </div>
            </section>
        </main>

        <!-- Ayna Mod√ºl√º Sayfasƒ± -->
        <main id="mirror-page" class="flex-1 hidden-page grid grid-cols-1 lg:grid-cols-12 gap-4 overflow-hidden">
            <aside class="lg:col-span-3 glass-panel rounded-2xl p-4 flex flex-col overflow-hidden">
                <div class="flex justify-between items-center mb-3">
                    <h2 class="font-bold text-xs uppercase text-purple-400 italic">AYNA KATILIMCILARI</h2>
                    <span id="mirror-user-count" class="text-purple-400 text-xs font-mono">0</span>
                </div>
                <div id="mirror-user-list" class="flex-1 overflow-y-auto space-y-1.5 pr-2 custom-scrollbar"></div>
                <div class="mt-4 pt-4 border-t border-white/5 space-y-2">
                    <button id="mirror-start-btn" onclick="toggleMirrorJoin(true)" class="w-full bg-purple-600 text-white font-black py-3 rounded-lg transition uppercase text-[10px]">KATILIMI A√á</button>
                    <button id="mirror-stop-btn" onclick="toggleMirrorJoin(false)" class="hidden w-full bg-rose-600 text-white font-black py-3 rounded-lg transition uppercase text-[10px]">KATILIMI KAPAT</button>
                    
                    <button onclick="window.clearFirestoreCollection('mirror')" class="w-full bg-slate-700 hover:bg-rose-900 text-slate-400 hover:text-white font-black py-3 rounded-lg transition uppercase border border-white/10 text-[10px]">Lƒ∞STEYƒ∞ TEMƒ∞ZLE</button>

                    <button id="mirror-raffle-btn" onclick="startMirrorRaffle()" class="w-full bg-purple-500 text-white font-bold py-4 rounded-xl transition uppercase text-xs mt-2">OYUNCU SE√á</button>
                    
                    <button onclick="showRules('mirror')" class="w-full text-[9px] bg-slate-700/50 hover:bg-slate-700 text-slate-300 py-2 rounded border border-white/10 uppercase font-bold mt-2">‚ùì Nasƒ±l Oynanƒ±r?</button>
                </div>
            </aside>

            <section class="lg:col-span-9 glass-panel rounded-2xl p-6 flex flex-col overflow-hidden relative">
                <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 h-full">
                    <div class="lg:col-span-8 flex flex-col">
                        <div id="mirror-winner-display" class="mb-4 text-center opacity-0 transition-all">
                            <h3 class="text-purple-400 text-[10px] font-bold tracking-widest uppercase mb-1">SIRADAKƒ∞ OYUNCU</h3>
                            <div id="mirror-winner-name" class="text-3xl font-black text-white italic tracking-tighter">BEKLENƒ∞YOR</div>
                            <div id="mirror-selection-count" class="text-xs text-yellow-500 font-bold mt-1">HAK: 3 / 3</div>
                        </div>
                        <div id="mirror-grid" class="grid grid-cols-5 gap-3"></div>
                        <div id="mirror-total-score-panel" class="mt-auto pt-6 text-center opacity-0 transition-all">
                            <div class="text-xs text-slate-400 uppercase font-bold mb-1">TOPLAM PUAN</div>
                            <div id="mirror-total-score" class="text-5xl font-black text-white italic">0</div>
                        </div>
                    </div>

                    <div class="lg:col-span-4 flex flex-col bg-black/20 rounded-2xl p-4 border border-white/5 overflow-y-auto custom-scrollbar">
                        <h3 class="text-yellow-500 text-xs font-black tracking-widest uppercase mb-4 text-center italic">PUAN √ñD√úLLERƒ∞</h3>
                        <div id="reward-pyramid" class="space-y-1"></div>
                        <div id="mirror-result-announcement" class="mt-6 text-center opacity-0 transition-all transform translate-y-4">
                            <div class="text-[10px] text-slate-400 uppercase font-bold mb-1">KAZANILAN √ñD√úL</div>
                            <div id="mirror-reward-text" class="text-xl font-black text-emerald-400 uppercase italic leading-tight">...</div>
                            <button onclick="resetMirrorRound()" class="mt-4 bg-purple-500 text-white px-6 py-2 rounded-full text-[10px] font-black uppercase">SIRADAKƒ∞ OYUNCU</button>
                        </div>
                    </div>
                </div>
            </section>
        </main>

        <!-- YENƒ∞ OYUN: TICKET GAME (Bƒ∞LET OYUNU) -->
        <main id="ticket-page" class="flex-1 hidden-page grid grid-cols-1 lg:grid-cols-12 gap-4 overflow-hidden">
            <aside class="lg:col-span-3 glass-panel rounded-2xl p-4 flex flex-col overflow-hidden">
                <div class="flex justify-between items-center mb-3">
                    <h2 class="font-bold text-xs uppercase text-amber-400 italic">Bƒ∞LET SAHƒ∞PLERƒ∞</h2>
                    <span id="ticket-user-count" class="text-amber-400 text-xs font-mono">0</span>
                </div>
                <div id="ticket-user-list" class="flex-1 overflow-y-auto space-y-1.5 pr-2 custom-scrollbar"></div>
                <div class="mt-4 pt-4 border-t border-white/5 space-y-2">
                    <button id="ticket-start-btn" onclick="toggleTicketJoin(true)" class="w-full bg-amber-600 text-slate-900 font-black py-3 rounded-lg transition uppercase text-[10px]">KATILIMI A√á</button>
                    <button id="ticket-stop-btn" onclick="toggleTicketJoin(false)" class="hidden w-full bg-rose-600 text-white font-black py-3 rounded-lg transition uppercase text-[10px]">KATILIMI KAPAT</button>
                    
                    <button onclick="window.clearFirestoreCollection('ticket')" class="w-full bg-slate-700/50 hover:bg-rose-900/50 text-slate-400 hover:text-rose-400 font-black py-3 rounded-lg transition uppercase border border-white/5 text-[10px]">Lƒ∞STEYƒ∞ TEMƒ∞ZLE</button>

                    <button id="draw-ticket-btn" onclick="startTicketDraw()" class="w-full bg-amber-500 hover:bg-amber-400 text-slate-900 font-bold py-4 rounded-xl transition uppercase text-xs mt-2 shadow-[0_0_20px_rgba(245,158,11,0.3)]">√áEKƒ∞Lƒ∞≈ûƒ∞ BA≈ûLAT</button>
                    <button onclick="showRules('ticket')" class="w-full text-[9px] bg-slate-700/50 hover:bg-slate-700 text-slate-300 py-2 rounded border border-white/10 uppercase font-bold mt-2">‚ùì Nasƒ±l Oynanƒ±r?</button>
                </div>
            </aside>
            <section class="lg:col-span-9 glass-panel rounded-2xl p-6 flex flex-col items-center justify-center relative overflow-hidden bg-gradient-to-br from-slate-900 to-amber-950/30">
                
                <div class="text-center mb-10">
                    <h2 class="text-4xl font-black text-amber-500 uppercase tracking-widest italic drop-shadow-[0_2px_10px_rgba(245,158,11,0.5)]">≈ûANSLI NUMARALAR</h2>
                </div>

                <!-- Ticket Numbers Display -->
                <div class="flex gap-4 md:gap-8 mb-12">
                    <div id="ticket-ball-1" class="ticket-ball">?</div>
                    <div id="ticket-ball-2" class="ticket-ball">?</div>
                    <div id="ticket-ball-3" class="ticket-ball">?</div>
                    <div id="ticket-ball-4" class="ticket-ball">?</div>
                    <div id="ticket-ball-5" class="ticket-ball">?</div>
                </div>

                <!-- Winner Announcement Area -->
                <div id="ticket-winner-area" class="text-center opacity-0 transition-all duration-700 transform translate-y-10">
                    <div class="text-xs text-slate-400 uppercase font-bold mb-2 tracking-[0.5em]">B√úY√úK ƒ∞KRAMƒ∞YE SAHƒ∞Bƒ∞</div>
                    <div id="ticket-winner-name" class="text-6xl font-black text-white uppercase italic drop-shadow-[0_0_30px_rgba(245,158,11,0.8)] scale-110"></div>
                </div>

                <button id="reveal-winner-btn" onclick="revealTicketWinner()" class="absolute bottom-10 bg-emerald-600 hover:bg-emerald-500 text-white px-10 py-4 rounded-full font-black uppercase tracking-widest shadow-lg hidden animate-bounce">KAZANANI G√ñSTER</button>

            </section>
        </main>

        <!-- RAFFLE PAGE -->
        <main id="raffle-page" class="flex-1 hidden-page grid grid-cols-1 lg:grid-cols-12 gap-4 overflow-hidden">
            <aside class="lg:col-span-3 glass-panel rounded-2xl p-4 flex flex-col overflow-hidden">
                <div class="flex justify-between items-center mb-3">
                    <h2 class="font-bold text-xs uppercase text-orange-400 italic">√áEKƒ∞Lƒ∞≈û Lƒ∞STESƒ∞</h2>
                    <span id="raffle-user-count" class="text-orange-400 text-xs font-mono">0</span>
                </div>
                <div id="raffle-user-list" class="flex-1 overflow-y-auto space-y-1.5 pr-2 custom-scrollbar"></div>
                <div class="mt-4 pt-4 border-t border-white/5 space-y-2">
                    <button id="raffle-start-btn" onclick="toggleRaffleJoin(true)" class="w-full bg-orange-600 text-white font-black py-3 rounded-lg transition uppercase text-[10px]">KATILIMI A√á</button>
                    <button id="raffle-stop-btn" onclick="toggleRaffleJoin(false)" class="hidden w-full bg-rose-600 text-white font-black py-3 rounded-lg transition uppercase text-[10px]">KATILIMI KAPAT</button>
                    
                    <button onclick="window.clearFirestoreCollection('raffle')" class="w-full bg-slate-700/50 hover:bg-rose-900/50 text-slate-400 hover:text-rose-400 font-black py-3 rounded-lg transition uppercase border border-white/5 text-[10px]">Lƒ∞STEYƒ∞ TEMƒ∞ZLE</button>

                    <button onclick="openBulkModal()" class="w-full bg-slate-700 hover:bg-slate-600 text-white text-[10px] font-black py-3 rounded-lg transition uppercase flex items-center justify-center gap-2 mt-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" /></svg>
                        MANUEL EKLE
                    </button>
                </div>
            </aside>
            <section class="lg:col-span-9 glass-panel rounded-2xl p-6 flex flex-col relative overflow-hidden">
                <!-- Controls -->
                <div class="flex flex-col md:flex-row gap-4 mb-6 border-b border-white/10 pb-6">
                    <div class="flex-1">
                        <label class="text-[10px] font-bold text-slate-400 uppercase mb-1 block">KAZANACAK Kƒ∞≈ûƒ∞ SAYISI</label>
                        <input type="number" id="raffle-draw-count" value="1" min="1" class="w-full bg-slate-900 border border-slate-700 rounded-xl p-3 text-white outline-none focus:border-orange-500 transition font-bold text-center text-lg">
                    </div>
                    <div class="flex-[2]">
                        <label class="text-[10px] font-bold text-slate-400 uppercase mb-1 block">VERƒ∞LECEK √ñD√úL</label>
                        <input type="text" id="raffle-reward-name" placeholder="√ñrn: 1000 Altƒ±n" class="w-full bg-slate-900 border border-slate-700 rounded-xl p-3 text-white outline-none focus:border-orange-500 transition font-bold text-lg">
                    </div>
                    <div class="flex-1 flex items-end">
                        <button id="start-raffle-btn" onclick="startBulkRaffleLoop()" class="w-full bg-orange-600 hover:bg-orange-500 h-[54px] rounded-xl font-black uppercase text-sm shadow-[0_0_20px_rgba(249,115,22,0.4)] transition active:scale-95 flex items-center justify-center gap-2 pulse-btn">
                            <span>√áEKƒ∞Lƒ∞≈ûƒ∞ BA≈ûLAT</span>
                        </button>
                    </div>
                </div>

                <!-- Results Grid -->
                <div class="flex-1 overflow-y-auto custom-scrollbar">
                    <div id="raffle-results-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 content-start">
                        <!-- Cards will appear here -->
                    </div>
                </div>
                
                <div id="raffle-status-msg" class="absolute bottom-2 right-4 text-[10px] text-orange-500 font-bold uppercase tracking-widest opacity-0 transition-opacity">
                    √áekili≈ü devam ediyor...
                </div>
            </section>
        </main>

        <!-- Wheel, Lucky, Dice Pages -->
        <main id="wheel-page" class="flex-1 hidden-page grid grid-cols-1 lg:grid-cols-12 gap-4 overflow-hidden">
            <aside class="lg:col-span-3 glass-panel rounded-2xl p-4 flex flex-col overflow-hidden">
                <div class="flex justify-between items-center mb-3">
                    <h2 class="font-bold text-xs uppercase text-emerald-400 italic">√áARK KATILIMCILARI</h2>
                    <span id="wheel-user-count" class="text-emerald-400 text-xs font-mono">0</span>
                </div>
                <div id="wheel-user-list" class="flex-1 overflow-y-auto space-y-1.5 pr-2 custom-scrollbar"></div>
                <div class="mt-4 pt-4 border-t border-white/5 space-y-2">
                    <button id="wheel-start-btn" onclick="toggleWheelJoin(true)" class="w-full bg-emerald-600 text-[10px] font-black py-3 rounded-lg transition uppercase">KATILIMI A√á</button>
                    <button id="wheel-stop-btn" onclick="toggleWheelJoin(false)" class="hidden w-full bg-rose-600 text-white text-[10px] font-black py-3 rounded-lg transition uppercase">KATILIMI KAPAT</button>
                    
                    <button onclick="window.clearFirestoreCollection('wheel')" class="w-full bg-slate-700 hover:bg-rose-900 text-slate-400 hover:text-white font-black py-3 rounded-lg transition uppercase border border-white/10 text-[10px]">Lƒ∞STEYƒ∞ TEMƒ∞ZLE</button>
                    
                    <button id="wheel-raffle-btn" onclick="startWheelRaffle()" class="w-full bg-emerald-500 text-slate-900 font-bold py-4 rounded-xl transition uppercase text-xs mt-2">OYUNCU SE√á</button>
                    <button onclick="showRules('wheel')" class="w-full text-[9px] bg-slate-700/50 hover:bg-slate-700 text-slate-300 py-2 rounded border border-white/10 uppercase font-bold mt-2">‚ùì Nasƒ±l Oynanƒ±r?</button>
                </div>
            </aside>
            <section class="lg:col-span-9 glass-panel rounded-2xl p-6 flex flex-col items-center justify-center relative overflow-hidden">
                <div id="wheel-winner-banner" class="mb-8 text-center opacity-0 transition-all">
                    <h3 class="text-emerald-400 text-[10px] font-bold tracking-widest uppercase mb-1">SIRADAKƒ∞ OYUNCU</h3>
                    <div id="wheel-winner-name" class="text-4xl font-black text-white italic tracking-tighter">BEKLENƒ∞YOR</div>
                    <div id="wheel-winner-reward" class="mt-4 opacity-0 transform translate-y-2 transition-all flex justify-center"></div>
                </div>
                <div class="wheel-container">
                    <div class="wheel-pointer"></div>
                    <div class="wheel-3d-wrapper">
                        <canvas id="wheel-canvas" width="450" height="450" class="wheel-canvas"></canvas>
                    </div>
                </div>
                <button id="spin-btn" onclick="spinWheel()" class="mt-10 bg-emerald-500 px-16 py-5 rounded-2xl text-slate-900 font-black uppercase shadow-[0_0_30px_rgba(16,185,129,0.4)] hover:scale-105 transition active:scale-95">√áARKI D√ñND√úR</button>
            </section>
        </main>

        <!-- ≈ûANS TOPU -->
        <main id="lucky-page" class="flex-1 hidden-page grid grid-cols-1 lg:grid-cols-12 gap-4 overflow-hidden">
            <aside class="lg:col-span-3 glass-panel rounded-2xl p-4 flex flex-col overflow-hidden">
                <div class="flex justify-between items-center mb-3"><h2 class="font-bold text-xs uppercase text-yellow-400 italic">KATILIMCILAR</h2><span id="lucky-user-count" class="text-yellow-400 text-xs font-mono">0</span></div>
                <div id="lucky-user-list" class="flex-1 overflow-y-auto space-y-1.5 pr-2 custom-scrollbar"></div>
                <div class="mt-4 pt-4 border-t border-white/5 space-y-2">
                    <button id="lucky-start-btn" onclick="toggleLuckyJoin(true)" class="w-full bg-yellow-600 text-slate-900 font-black py-3 rounded-lg transition uppercase text-[10px]">KATILIMI BA≈ûLAT</button>
                    <button id="lucky-stop-btn" onclick="toggleLuckyJoin(false)" class="hidden w-full bg-rose-600 text-white font-black py-3 rounded-lg transition uppercase text-[10px]">KATILIMI KAPAT</button>
                    
                    <button onclick="window.clearFirestoreCollection('lucky')" class="w-full bg-slate-700 hover:bg-rose-900 text-slate-400 hover:text-white font-black py-3 rounded-lg transition uppercase border border-white/10 text-[10px]">Lƒ∞STEYƒ∞ TEMƒ∞ZLE</button>
                    
                    <button id="roll-lucky-btn" onclick="rollLuckyBalls()" class="w-full bg-yellow-400 text-slate-900 font-bold py-4 rounded-xl transition uppercase text-xs mt-2">TOPLARI √áEVƒ∞R!</button>
                    <button onclick="showRules('lucky')" class="w-full text-[9px] bg-slate-700/50 hover:bg-slate-700 text-slate-300 py-2 rounded border border-white/10 uppercase font-bold mt-2">‚ùì Nasƒ±l Oynanƒ±r?</button>
                </div>
            </aside>
            <section class="lg:col-span-9 glass-panel rounded-2xl p-6 flex flex-col items-center justify-center relative overflow-hidden">
                <!-- B√ºy√ºk √ñd√ºl Paneli Sabitlendi -->
                <div class="jackpot-counter px-10 py-6 rounded-3xl mb-10 text-center relative overflow-hidden z-20 shrink-0">
                    <h3 class="text-yellow-500 text-xs font-black tracking-[0.3em] uppercase mb-2">B√úY√úK √ñD√úL HAVUZU</h3>
                    <div id="lucky-jackpot-display" class="text-6xl font-black text-white italic drop-shadow-lg">0 ALTIN</div>
                </div>
                
                <div class="flex gap-10 mb-8 relative shrink-0">
                    <div id="ball-1" class="lucky-ball">?</div>
                    <div id="ball-2" class="lucky-ball">?</div>
                    <div id="ball-3" class="lucky-ball">?</div>
                </div>

                <div id="lucky-result-panel" class="w-full max-w-2xl bg-slate-900/80 rounded-3xl p-6 border border-yellow-500/20 opacity-0 transition-all transform translate-y-4 flex flex-col overflow-hidden max-h-[350px]">
                    <div id="lucky-winners-display" class="lucky-winners-list grid grid-cols-1 gap-2 pr-2 custom-scrollbar">
                        <!-- Kazananlar burada a≈üaƒüƒ± doƒüru sƒ±ralanacak -->
                    </div>
                    <div id="lucky-final-announcement" class="mt-4 pt-4 border-t border-white/10 text-center font-black text-xl text-yellow-400 uppercase italic shrink-0"></div>
                </div>
            </section>
        </main>

        <main id="dice-page" class="flex-1 hidden-page grid grid-cols-1 lg:grid-cols-12 gap-4 overflow-hidden">
            <aside class="lg:col-span-3 glass-panel rounded-2xl p-4 flex flex-col overflow-hidden">
                <div class="flex justify-between items-center mb-3"><h2 class="font-bold text-xs uppercase text-indigo-400 italic">ZAR KATILIMCILARI</h2><span id="dice-user-count" class="text-indigo-400 text-xs font-mono">0</span></div>
                <div id="dice-user-list" class="flex-1 overflow-y-auto space-y-1.5 pr-2 custom-scrollbar"></div>
                <div class="mt-4 pt-4 border-t border-white/5 space-y-2">
                    <button id="dice-start-btn" onclick="toggleDiceJoin(true)" class="w-full bg-indigo-600 text-white font-black py-3 rounded-lg transition uppercase text-[10px]">KATILIMI BA≈ûLAT</button>
                    <button id="dice-stop-btn" onclick="toggleDiceJoin(false)" class="hidden w-full bg-rose-600 text-white font-black py-3 rounded-lg transition uppercase text-[10px]">KATILIMI KAPAT</button>
                    
                    <button onclick="window.clearFirestoreCollection('dice')" class="w-full bg-slate-700 hover:bg-rose-900 text-slate-400 hover:text-white font-black py-3 rounded-lg transition uppercase border border-white/10 text-[10px]">Lƒ∞STEYƒ∞ TEMƒ∞ZLE</button>
                    
                    <button id="roll-dice-btn" onclick="rollDice()" class="w-full bg-indigo-500 text-white font-bold py-4 rounded-xl transition uppercase text-xs mt-2">ZARLARI AT!</button>
                    <button onclick="showRules('dice')" class="w-full text-[9px] bg-slate-700/50 hover:bg-slate-700 text-slate-300 py-2 rounded border border-white/10 uppercase font-bold mt-2">‚ùì Nasƒ±l Oynanƒ±r?</button>
                </div>
            </aside>
            <section class="lg:col-span-9 glass-panel rounded-2xl p-6 flex flex-col items-center justify-center relative overflow-hidden">
                <div class="jackpot-counter px-10 py-6 rounded-3xl mb-10 text-center border-indigo-500/50 shrink-0"><h3 class="text-indigo-400 text-xs font-black tracking-[0.3em] uppercase mb-2">ZAR B√úY√úK √ñD√úL</h3><div id="dice-jackpot-display" class="text-6xl font-black text-white italic drop-shadow-lg">0 ALTIN</div></div>
                <div class="flex gap-4 mb-8 relative flex-wrap justify-center shrink-0"><div id="dice-1" class="dice-container"></div><div id="dice-2" class="dice-container"></div><div id="dice-3" class="dice-container"></div><div id="dice-4" class="dice-container"></div><div id="dice-5" class="dice-container"></div></div>
                <div id="dice-total-display" class="text-4xl font-black text-white uppercase mb-4 opacity-0 shrink-0">TOPLAM: <span id="dice-sum" class="text-indigo-400">0</span></div>
                <div id="dice-result-panel" class="w-full max-w-2xl bg-slate-900/80 rounded-3xl p-6 border border-indigo-500/20 opacity-0 transition-all transform translate-y-4 overflow-hidden max-h-[300px] flex flex-col"><div id="dice-winners-display" class="overflow-y-auto pr-2 custom-scrollbar grid grid-cols-1 gap-2"></div><div id="dice-final-announcement" class="mt-4 pt-4 border-t border-white/10 text-center font-black text-xl text-indigo-400 uppercase italic"></div></div>
            </section>
        </main>

        <!-- Stats Page (UPDATED WITH RACE) -->
        <main id="stats-page" class="flex-1 hidden-page glass-panel rounded-2xl p-6 flex flex-col overflow-hidden">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-black text-emerald-400 uppercase tracking-wider">OYUNCU ƒ∞STATƒ∞STƒ∞KLERƒ∞</h2>
                <div class="relative">
                    <input type="text" id="stats-search" onkeyup="filterStats()" placeholder="Oyuncu Ara..." class="bg-slate-900 border border-slate-700 rounded-lg px-4 py-2 text-white text-sm outline-none focus:border-emerald-500 w-64">
                </div>
            </div>
            
            <div class="flex-1 flex flex-col bg-slate-900/50 rounded-xl overflow-hidden border border-white/5">
                <div class="stats-header stats-table-row border-b border-slate-700">
                    <div class="text-center">#</div>
                    <div>OYUNCU ADI</div>
                    <div class="text-center">IRK</div> <!-- Yeni S√ºtun -->
                    <div class="text-center">KATILIM</div>
                    <div class="text-center">KAZANMA</div>
                    <div class="text-center">Sƒ∞L</div>
                </div>
                <div id="stats-list" class="flex-1 overflow-y-auto custom-scrollbar">
                    <!-- Stats rows will be here -->
                </div>
            </div>
        </main>

        <main id="winners-page" class="flex-1 hidden-page glass-panel rounded-2xl p-6 flex flex-col overflow-hidden">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-black text-sky-400 uppercase tracking-wider">KAZANIM AR≈ûƒ∞Vƒ∞</h2>
                <button onclick="exportWinners()" class="bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-2 px-4 rounded-lg text-xs uppercase flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                    DI≈ûA AKTAR (.TXT)
                </button>
            </div>
            <div id="winners-log-large" class="flex-1 overflow-y-auto space-y-2 pr-2 custom-scrollbar"></div>
        </main>

        <!-- Config Page (D√úZEN DEƒûƒ∞≈ûTƒ∞Rƒ∞LDƒ∞) -->
        <main id="config-page" class="flex-1 hidden-page glass-panel rounded-2xl p-8 overflow-y-auto custom-scrollbar">
            <h2 class="text-3xl font-black text-yellow-500 uppercase tracking-widest mb-8 border-b border-white/10 pb-4">Sƒ∞STEM KONFƒ∞G√úRASYONU</h2>
            
            <!-- AYARLAR √úSTE TA≈ûINDI -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
                <div class="space-y-6">
                    <div><label class="text-xs uppercase text-slate-500 font-bold mb-2 block">Kutu Sayƒ±sƒ±</label><input type="number" id="box-count-input" value="25" class="w-full bg-slate-900 border border-slate-700 rounded-xl p-3 text-white outline-none"></div>
                    <div>
                        <label class="text-xs uppercase text-sky-500 font-bold mb-2 block">Kutu √ñd√ºlleri (Aktif Liste)</label>
                        <p class="text-[9px] text-slate-400 mb-2">A≈üaƒüƒ±daki havuzdan "Kutuya Ekle" diyerek buraya aktarabilirsiniz.</p>
                        <textarea id="reward-input" class="w-full h-32 bg-slate-900 border border-slate-700 rounded-xl p-4 text-sm outline-none resize-none font-mono" placeholder="√ñrn: 100 Altƒ±n"></textarea>
                    </div>
                    <div>
                        <label class="text-xs uppercase text-emerald-500 font-bold mb-2 block">√áark √ñd√ºlleri (Aktif Liste)</label>
                        <p class="text-[9px] text-slate-400 mb-2">A≈üaƒüƒ±daki havuzdan "√áarka Ekle" diyerek buraya aktarabilirsiniz.</p>
                        <textarea id="wheel-reward-input" class="w-full h-32 bg-slate-900 border border-slate-700 rounded-xl p-4 text-sm outline-none resize-none font-mono" placeholder="√ñrn: 1000 Altƒ±n"></textarea>
                    </div>
                </div>
                <div class="space-y-6">
                    <div><label class="text-xs uppercase text-purple-500 font-bold mb-2 block italic">Ayna Puan √ñd√ºlleri</label><textarea id="mirror-reward-input" class="w-full h-32 bg-slate-900 border border-purple-700 rounded-xl p-4 text-sm outline-none resize-none font-mono">15: 
12: 
11: 
9: 
8: 
7: 
6: 
5: 
4: 
3: 
 </textarea></div>
                    <div class="p-6 bg-white/5 rounded-2xl border border-white/10"><label class="text-xs uppercase text-yellow-500 font-bold italic mb-4 block underline">≈ûans Topu B√ºy√ºk √ñd√ºl</label><input type="number" id="lucky-jackpot-input" value="0" class="w-full bg-slate-900 border border-yellow-700/50 rounded-xl p-3 text-white"></div>
                    <div class="p-6 bg-white/5 rounded-2xl border border-white/10"><label class="text-xs uppercase text-indigo-500 font-bold italic mb-4 block underline">Zar Oyunu B√ºy√ºk √ñd√ºl</label><input type="number" id="dice-jackpot-input" value="0" class="w-full bg-slate-900 border border-indigo-700/50 rounded-xl p-3 text-white"></div>
                    <button onclick="updateSettingsAndSync()" class="w-full bg-emerald-600 hover:bg-emerald-500 py-6 rounded-2xl font-black transition uppercase text-lg shadow-lg">AYARLARI KAYDET</button>
                </div>
            </div>

            <!-- √ñD√úL HAVUZU Y√ñNETƒ∞Mƒ∞ ALTA TA≈ûINDI -->
            <div class="p-6 bg-slate-900/80 rounded-2xl border border-sky-500/30 shadow-[0_0_30px_rgba(14,165,233,0.1)]">
                <div class="flex justify-between items-end mb-4">
                    <h3 class="text-xl font-bold text-sky-400 uppercase tracking-widest italic flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" /></svg>
                        KALICI √ñD√úL HAVUZU
                    </h3>
                    <span class="text-[10px] text-slate-400 uppercase font-bold">Buradaki √∂d√ºller veritabanƒ±na kaydedilir</span>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                    <input id="pool-reward-name" type="text" placeholder="√ñd√ºl Adƒ± (√ñrn: 1000 Altƒ±n)" class="md:col-span-2 bg-slate-800 border border-slate-600 rounded-xl p-3 text-white outline-none focus:border-sky-500 transition text-sm">
                    <input id="pool-reward-image" type="text" placeholder="Resim Linki (ƒ∞steƒüe baƒülƒ±)" class="bg-slate-800 border border-slate-600 rounded-xl p-3 text-white outline-none focus:border-sky-500 transition text-sm">
                    <button onclick="addRewardToPool()" class="bg-sky-600 hover:bg-sky-500 text-white font-bold rounded-xl transition uppercase text-xs shadow-lg">HAVUZA EKLE +</button>
                </div>

                <div id="pool-list-display" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 max-h-[300px] overflow-y-auto custom-scrollbar p-1">
                    <!-- Pool Items Rendered Here -->
                    <div class="text-center w-full col-span-3 text-slate-500 text-xs italic py-4">Havuz bo≈ü. Yukarƒ±dan √∂d√ºl ekleyin.</div>
                </div>
            </div>

        </main>

        <div class="marquee-container">
            <div id="marquee" class="marquee-content">
                <span class="text-sky-400 font-bold uppercase tracking-widest text-xs italic">Dwar Etkinlik Merkezi Aktif! Kazananlarƒ± Bekliyoruz...</span>
            </div>
        </div>

        <!-- Rules Modal -->
        <div id="rules-modal" class="rules-modal">
            <div class="rules-content">
                <button onclick="closeRules()" class="rules-close">‚úï</button>
                <h2 id="rules-title" class="text-2xl font-black uppercase text-sky-400 mb-4 tracking-widest">NASIL OYNANIR?</h2>
                <div id="rules-text" class="text-slate-300 text-sm leading-relaxed space-y-2"></div>
            </div>
        </div>

        <!-- Bulk Add Modal -->
        <div id="bulk-modal" class="bulk-modal">
            <div class="bulk-content border-t-2 border-orange-500">
                <button onclick="closeBulkModal()" class="rules-close">‚úï</button>
                <h2 class="text-2xl font-black uppercase text-orange-400 mb-4 tracking-widest">KATILIMCI EKLE</h2>
                <p class="text-[10px] text-slate-400 mb-2">Her satƒ±ra bir isim gelecek ≈üekilde listeyi yapƒ±≈ütƒ±rƒ±n:</p>
                <textarea id="bulk-input" class="w-full h-48 bg-slate-900 border border-slate-700 rounded-xl p-4 text-sm outline-none resize-none font-mono text-white mb-4 placeholder-slate-600" placeholder="Kullanƒ±cƒ±1&#10;Kullanƒ±cƒ±2&#10;Kullanƒ±cƒ±3..."></textarea>
                <button onclick="processBulkAdd()" class="w-full bg-orange-600 hover:bg-orange-500 text-white font-bold py-3 rounded-xl transition uppercase text-xs">Lƒ∞STEYƒ∞ EKLE</button>
            </div>
        </div>
        
        <!-- Player Details Modal -->
        <div id="stats-modal" class="stats-modal">
            <div class="stats-content border-t-2 border-emerald-500">
                <button onclick="document.getElementById('stats-modal').classList.remove('active')" class="rules-close">‚úï</button>
                <h2 id="stats-player-name" class="text-3xl font-black uppercase text-emerald-400 mb-2 tracking-widest">OYUNCU ADI</h2>
                <div class="flex gap-4 mb-4 text-xs font-bold text-slate-400 uppercase">
                    <span id="stats-detail-wins">Toplam Zafer: 0</span>
                    <span id="stats-detail-parts">Toplam Katƒ±lƒ±m: 0</span>
                </div>
                <div class="text-[10px] text-slate-500 uppercase font-bold mb-2 border-b border-white/10 pb-1">KAZANMA GE√áMƒ∞≈ûƒ∞</div>
                <div id="stats-history-list" class="h-64 overflow-y-auto custom-scrollbar space-y-2">
                    <!-- History items -->
                </div>
            </div>
        </div>

    </div> <!-- End of App Container -->

    <script>
        // --- SECURE LOGIN LOGIC (2FA ENABLED + OBFUSCATED) ---
        
        // Bu kod par√ßalarƒ± "ƒ∞ncele" yapanlarƒ±n doƒürudan ≈üifreyi g√∂rmesini engellemek i√ßin
        // par√ßalanmƒ±≈ü stringlerden olu≈üur.
        // Gizli Anahtar (Secret): JBSWY3DPEHPK3PXP
        const _0x1a2b = ['J', 'B', 'S', 'W', 'Y', '3', 'D', 'P', 'E', 'H', 'P', 'K', '3', 'P', 'X', 'P'];
        
        // HASHED_USER: admin (8c6976...)
        const _uH = "8c6976e5b5410415bde908bd4dee15dfb167a9c873fc4bb8a81f6f2ab448a918";
        // HASHED_PASS: 12345 (599447...)
        const _pH = "5994471abb01112afcc18159f6cc74b4f511b99806da59b3caf5a9c173cacfc5";

        async function sha256(message) {
            const msgBuffer = new TextEncoder().encode(message);
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        async function initiateLogin() {
            const uVal = document.getElementById('login-user').value;
            const pVal = document.getElementById('login-pass').value;
            const err = document.getElementById('login-error');

            const uH = await sha256(uVal);
            const pH = await sha256(pVal);

            if(uH === _uH && pH === _pH) {
                // ≈ûifre Doƒüru, 2. A≈üamaya Ge√ß (OTP)
                err.classList.add('hidden');
                document.getElementById('login-step-1').classList.add('hidden');
                document.getElementById('login-step-2').classList.remove('hidden');
                document.getElementById('otp-code').focus();
            } else {
                showError("Hatalƒ± Kullanƒ±cƒ± Adƒ± veya ≈ûifre!");
            }
        }

        function verify2FA() {
            const code = document.getElementById('otp-code').value.replace(/\s/g, '');
            if(code.length < 6) return showError("Kod eksik girildi.");

            // Gizli anahtarƒ± birle≈ütir
            const secret = _0x1a2b.join('');
            
            // OTP Kontrol√º (otpauth k√ºt√ºphanesi)
            // Bu kod 30 saniyelik zaman diliminde ge√ßerli mi diye bakar.
            // window = 1 demek, √∂nceki veya sonraki 30 saniyeyi de kabul et (saat farkƒ± i√ßin tolerans)
            const totp = new OTPAuth.TOTP({
                algorithm: 'SHA1',
                digits: 6,
                period: 30,
                secret: OTPAuth.Secret.fromBase32(secret)
            });

            // Token doƒürula (delta d√∂nerse ba≈üarƒ±lƒ±dƒ±r)
            const delta = totp.validate({ token: code, window: 1 });

            if (delta !== null) {
                // BA≈ûARILI Gƒ∞Rƒ∞≈û
                document.getElementById('login-overlay').style.opacity = '0';
                setTimeout(() => {
                    document.getElementById('login-overlay').style.display = 'none';
                    const appEl = document.getElementById('app-container');
                    appEl.classList.remove('hidden');
                    window.dispatchEvent(new Event('resize'));
                    // Firebase Ba≈ülat
                    if(window.startFirebase) window.startFirebase();
                }, 500);
            } else {
                showError("Ge√ßersiz veya s√ºresi dolmu≈ü kod!");
            }
        }

        function backToStep1() {
            document.getElementById('login-step-2').classList.add('hidden');
            document.getElementById('login-step-1').classList.remove('hidden');
            document.getElementById('login-error').classList.add('hidden');
        }

        function showError(msg) {
            const err = document.getElementById('login-error');
            err.innerText = msg;
            err.classList.remove('hidden');
            document.querySelector('.login-card').classList.add('pulse-btn');
            setTimeout(() => document.querySelector('.login-card').classList.remove('pulse-btn'), 500);
        }

        // --- EXISTING LOGIC ---
        const state = {
            isJoinEnabled: false, users: [], eliminatedUsers: [], currentWinner: null, isBoxOpened: false, boxRewards: [],
            isWheelJoinEnabled: false, wheelUsers: [], eliminatedWheelUsers: [], wheelWinner: null, wheelAngle: 0, isWheelSpinning: false,
            isLuckyJoinEnabled: false, luckyUsers: [], isLuckyRolling: false, luckyResult: [0, 0, 0], luckyWinnersIds: [],
            isDiceJoinEnabled: false, diceUsers: [], isDiceRolling: false, diceResult: [], diceSum: 0, diceWinnersIds: [],
            isMirrorJoinEnabled: false, mirrorUsers: [], eliminatedMirrorUsers: [], mirrorWinner: null, 
            mirrorValues: [], mirrorSelections: 0, mirrorCurrentTotal: 0, mirrorCount: 15, mirrorSelectionIndices: [],
            isRaffleJoinEnabled: false, raffleUsers: [], eliminatedRaffleUsers: [], isRaffleRunning: false,
            isTicketJoinEnabled: false, ticketUsers: [], ticketWinner: null, 
            winners: [],
            allStats: [], 
            rewardPool: [], 
            config: { boxCount: 25, rewards: [], wheelRewards: [], mirrorRewardsMap: {}, luckyJackpot: 1000, diceJackpot: 2500, wheelSize: 450 },
            colors: ["#ef4444", "#f97316", "#f59e0b", "#eab308", "#84cc16", "#22c55e", "#10b981", "#06b6d4", "#0ea5e9", "#3b82f6", "#6366f1", "#8b5cf6", "#a855f7", "#d946ef", "#ec4899", "#f43f5e"]
        };

        const rulesData = {
            game: {
                title: "KUTU OYUNU KURALLARI",
                text: `<p>1. Y√∂netici katƒ±lƒ±mƒ± a√ßar ve oyuncular sisteme dahil olur.</p>
                       <p>2. "Oyuncu Se√ß" butonu ile rastgele bir ≈üanslƒ± ki≈üi belirlenir.</p>
                       <p>3. Se√ßilen oyuncu ekrandaki kutulardan bir numara se√ßer.</p>
                       <p>4. Kutu a√ßƒ±lƒ±r ve i√ßindeki √∂d√ºl (veya Pas) oyuncunun olur.</p>`
            },
            mirror: {
                title: "AYNA MOD√úL√ú KURALLARI",
                text: `<p>1. Se√ßilen oyuncu ekrandaki 15 karttan 3 tanesini se√ßme hakkƒ±na sahiptir.</p>
                       <p>2. Kartlarƒ±n arkasƒ±nda 1, 2 veya 5 puan gizlidir.</p>
                       <p>3. Oyuncunun bulduƒüu 3 puan toplanƒ±r.</p>
                       <p>4. Toplam puana kar≈üƒ±lƒ±k gelen √∂d√ºl, saƒüdaki √∂d√ºl piramidinden verilir.</p>`
            },
            wheel: {
                title: "≈ûANSLI √áARK KURALLARI",
                text: `<p>1. Katƒ±lƒ±mcƒ±lar arasƒ±ndan bir ki≈üi se√ßilir.</p>
                       <p>2. "√áarkƒ± D√∂nd√ºr" butonuna basƒ±lƒ±r.</p>
                       <p>3. √áark durduƒüunda ibrenin g√∂sterdiƒüi dilimdeki √∂d√ºl kazanƒ±lƒ±r.</p>
                       <p>4. √ñd√ºller tamamen ≈üansa dayalƒ±dƒ±r ve her dilimin gelme ihtimali e≈üittir.</p>`
            },
            lucky: {
                title: "≈ûANS TOPU KURALLARI",
                text: `<p>1. Oyuncular 1'den 9'a kadar olan rakamlardan olu≈üan 3 haneli bir kombinasyon se√ßer (√ñrn: 1-5-9).</p>
                       <p>2. Sistem 3 adet topu rastgele √ßeker.</p>
                       <p>3. <strong>3 Bilenler:</strong> B√ºy√ºk √∂d√ºl havuzunu payla≈üƒ±r.</p>
                       <p>4. <strong>2 Bilenler:</strong> Havuzun %50'sini payla≈üƒ±r.</p>
                       <p>5. <strong>1 Bilenler:</strong> Havuzun %25'ini payla≈üƒ±r.</p>`
            },
            dice: {
                title: "ZAR OYUNU KURALLARI",
                text: `<p>1. Oyuncular 5 zarƒ±n toplamƒ±nƒ±n ka√ß geleceƒüini tahmin eder (Min: 5, Max: 30).</p>
                       <p>2. "/zar [tahmin]" komutu ile katƒ±lƒ±m saƒülanƒ±r.</p>
                       <p>3. 5 zar atƒ±lƒ±r ve gelen rakamlar toplanƒ±r.</p>
                       <p>4. Toplam sonucu tam bilen oyuncular b√ºy√ºk √∂d√ºl√º e≈üit olarak payla≈üƒ±r.</p>`
            },
            ticket: {
                title: "Bƒ∞LET OYUNU KURALLARI",
                text: `<p>1. Katƒ±lƒ±m ba≈üladƒ±ƒüƒ±nda her oyuncuya 5 haneli BENZERSƒ∞Z bir bilet numarasƒ± verilir.</p>
                       <p>2. √áekili≈ü ba≈üladƒ±ƒüƒ±nda 5 rakam sƒ±rayla belirlenir.</p>
                       <p>3. Bilet numarasƒ± ekrandaki numara ile tam e≈üle≈üen ki≈üi b√ºy√ºk √∂d√ºl√º kazanƒ±r.</p>`
            }
        };

        function showRules(type) {
            const data = rulesData[type];
            if(!data) return;
            document.getElementById('rules-title').innerText = data.title;
            document.getElementById('rules-title').className = `text-2xl font-black uppercase mb-4 tracking-widest ${getColorForType(type)}`;
            document.getElementById('rules-text').innerHTML = data.text;
            document.getElementById('rules-modal').classList.add('active');
        }

        function closeRules() { document.getElementById('rules-modal').classList.remove('active'); }
        
        function getColorForType(type) {
            const colors = { game: 'text-sky-400', mirror: 'text-purple-400', wheel: 'text-emerald-400', lucky: 'text-yellow-400', dice: 'text-indigo-400', ticket: 'text-amber-400' };
            return colors[type] || 'text-white';
        }

        function init() { 
            window.state = state;
            updateSettingsAndSync(); 
            window.requestAnimationFrame(drawWheel); 
            setInterval(updateMarquee, 2000); 
            renderDiceDots(document.getElementById('dice-1'), 1);
            renderDiceDots(document.getElementById('dice-2'), 2);
            renderDiceDots(document.getElementById('dice-3'), 3);
            renderDiceDots(document.getElementById('dice-4'), 4);
            renderDiceDots(document.getElementById('dice-5'), 5);
            createMirrorGrid();
        }
        
        // --- POOL FUNCTIONS ---
        function addRewardToPool() {
            const name = document.getElementById('pool-reward-name').value.trim();
            const img = document.getElementById('pool-reward-image').value.trim();
            if(!name) return alert("L√ºtfen √∂d√ºl adƒ±nƒ± giriniz.");
            state.rewardPool.push({ id: Date.now(), name: name, image: img });
            window.renderRewardPool();
            window.savePoolToFirestore();
            document.getElementById('pool-reward-name').value = "";
            document.getElementById('pool-reward-image').value = "";
        }

        function removeRewardFromPool(id) {
            if(!confirm("Bu √∂d√ºl√º havuzdan silmek istediƒüinize emin misiniz?")) return;
            state.rewardPool = state.rewardPool.filter(r => r.id !== id);
            window.renderRewardPool();
            window.savePoolToFirestore();
        }

        function appendToConfig(type, id) {
            const item = state.rewardPool.find(r => r.id === id);
            if(!item) return;
            let textToAdd = item.name;
            if(item.image) { textToAdd += ` | ${item.image}`; }
            textToAdd += "\n";
            if(type === 'box') { document.getElementById('reward-input').value += textToAdd; } 
            else if (type === 'wheel') { document.getElementById('wheel-reward-input').value += textToAdd; }
        }

        window.renderRewardPool = function() {
            const list = document.getElementById('pool-list-display');
            list.innerHTML = "";
            if(state.rewardPool.length === 0) {
                list.innerHTML = '<div class="text-center w-full col-span-3 text-slate-500 text-xs italic py-4">Havuz bo≈ü. Yukarƒ±dan √∂d√ºl ekleyin.</div>';
                return;
            }
            state.rewardPool.forEach(r => {
                const hasImg = r.image && r.image.trim() !== "";
                list.innerHTML += `
                    <div class="pool-item group">
                        ${hasImg ? `<img src="${r.image}" class="pool-img" onerror="this.style.display='none'">` : '<div class="pool-img flex items-center justify-center text-slate-600 text-[10px] font-bold">YOK</div>'}
                        <div class="flex-1 overflow-hidden">
                            <div class="text-[11px] font-bold text-white truncate">${r.name}</div>
                            <div class="flex gap-1 mt-1 opacity-60 group-hover:opacity-100 transition">
                                <button onclick="appendToConfig('box', ${r.id})" class="text-[9px] bg-sky-900/50 hover:bg-sky-600 px-2 py-0.5 rounded text-sky-200 hover:text-white">Kutuya Ekle</button>
                                <button onclick="appendToConfig('wheel', ${r.id})" class="text-[9px] bg-emerald-900/50 hover:bg-emerald-600 px-2 py-0.5 rounded text-emerald-200 hover:text-white">√áarka Ekle</button>
                            </div>
                        </div>
                        <button onclick="removeRewardFromPool(${r.id})" class="text-rose-500 hover:text-rose-300 font-bold px-2">‚úï</button>
                    </div>
                `;
            });
        }
        
        function updateSettingsAndSync() {
            state.config.boxCount = parseInt(document.getElementById('box-count-input').value) || 25;
            state.config.rewards = document.getElementById('reward-input').value.split('\n').filter(r => r.trim() !== "");
            state.config.wheelRewards = document.getElementById('wheel-reward-input').value.split('\n').filter(r => r.trim() !== "");
            state.config.luckyJackpot = parseInt(document.getElementById('lucky-jackpot-input').value) || 0;
            state.config.diceJackpot = parseInt(document.getElementById('dice-jackpot-input').value) || 0;
            const mirrorLines = document.getElementById('mirror-reward-input').value.split('\n');
            state.config.mirrorRewardsMap = {};
            mirrorLines.forEach(l => { const parts = l.split(':'); if(parts.length === 2) state.config.mirrorRewardsMap[parts[0].trim()] = parts[1].trim(); });
            document.getElementById('lucky-jackpot-display').innerText = state.config.luckyJackpot.toLocaleString() + " ALTIN";
            document.getElementById('dice-jackpot-display').innerText = state.config.diceJackpot.toLocaleString() + " ALTIN";
            shuffleRewards(); createBoxes(state.config.boxCount); drawWheel(); renderMirrorRewardTable();
            // alert("Ayarlar Ba≈üarƒ±yla Kaydedildi!"); // Remove annoy
        }

        function switchTab(tab) {
            const pages = { game: 'game-page', mirror: 'mirror-page', wheel: 'wheel-page', lucky: 'lucky-page', dice: 'dice-page', winners: 'winners-page', config: 'config-page', raffle: 'raffle-page', ticket: 'ticket-page', stats: 'stats-page' };
            const btns = { game: 'tab-game', mirror: 'tab-mirror', wheel: 'tab-wheel', lucky: 'tab-lucky', dice: 'tab-dice', winners: 'tab-winners', config: 'tab-config', raffle: 'tab-raffle', ticket: 'tab-ticket', stats: 'tab-stats' };
            Object.keys(pages).forEach(key => {
                const p = document.getElementById(pages[key]);
                const b = document.getElementById(btns[key]);
                if(p) p.classList.toggle('hidden-page', key !== tab);
                if(b) b.classList.toggle('active', key === tab);
            });
            if(tab === 'winners') renderLargeWinnersList();
            if(tab === 'stats') window.renderStatsTable();
        }

        // --- STATS LOGIC WITH RACE ---
        window.renderStatsTable = function() {
            const container = document.getElementById('stats-list');
            const search = document.getElementById('stats-search').value.toLowerCase();
            container.innerHTML = '';
            
            // Sort by wins (desc) then participation (desc)
            let data = state.allStats.sort((a,b) => (b.winCount || 0) - (a.winCount || 0) || (b.participationCount || 0) - (a.participationCount || 0));

            if(search) {
                data = data.filter(s => s.nick.toLowerCase().includes(search));
            }

            data.forEach((s, idx) => {
                const wins = s.winCount || 0;
                const parts = s.participationCount || 0;
                
                // IRK BELƒ∞RLEME
                let raceIcon = '<span class="text-slate-600 text-[10px]">-</span>';
                if(s.race) {
                    const r = s.race.toLowerCase();
                    if(r.includes('magron')) {
                        raceIcon = '<div class="flex flex-col items-center"><span class="text-lg">üåã</span><span class="text-[9px] text-red-500 font-bold uppercase">MAGRON</span></div>';
                    } else if (r.includes('insan') || r.includes('human')) {
                        raceIcon = '<div class="flex flex-col items-center"><span class="text-lg">üõ°Ô∏è</span><span class="text-[9px] text-blue-500 font-bold uppercase">ƒ∞NSAN</span></div>';
                    } else {
                         raceIcon = `<span class="text-slate-400 text-[9px] uppercase">${r}</span>`;
                    }
                }

                container.innerHTML += `
                    <div class="stats-table-row" onclick="openStatsDetail('${s.id}')">
                        <div class="text-center font-bold text-slate-500">${idx + 1}</div>
                        <div class="font-bold text-white truncate">${s.nick}</div>
                        <div class="text-center">${raceIcon}</div>
                        <div class="text-center text-slate-400 font-mono">${parts}</div>
                        <div class="text-center text-emerald-400 font-mono font-bold">${wins}</div>
                        <div class="text-center">
                            <button onclick="window.deleteStat('${s.id}', event)" class="text-rose-500 hover:text-white hover:bg-rose-600 rounded p-1 transition">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                            </button>
                        </div>
                    </div>
                `;
            });
        };

        window.filterStats = function() { window.renderStatsTable(); };

        window.openStatsDetail = function(id) {
            const player = state.allStats.find(s => s.id === id);
            if(!player) return;

            document.getElementById('stats-player-name').innerText = player.nick;
            document.getElementById('stats-detail-wins').innerText = `TOPLAM ZAFER: ${player.winCount || 0}`;
            document.getElementById('stats-detail-parts').innerText = `TOPLAM KATILIM: ${player.participationCount || 0}`;
            
            const historyList = document.getElementById('stats-history-list');
            historyList.innerHTML = '';
            
            const history = player.history || [];
            if(history.length === 0) {
                historyList.innerHTML = '<div class="text-center text-slate-500 italic py-4">Hen√ºz kayƒ±tlƒ± bir kazan√ß yok.</div>';
            } else {
                // Reverse chronological order
                [...history].reverse().forEach(h => {
                    const date = new Date(h.date).toLocaleDateString("tr-TR");
                    historyList.innerHTML += `
                        <div class="bg-black/20 p-2 rounded border border-white/5 flex justify-between items-center">
                            <div>
                                <div class="text-[10px] text-slate-400 font-bold">${h.game} | ${date}</div>
                                <div class="text-sm font-bold text-white">${h.detail}</div>
                            </div>
                            <div class="text-yellow-400 font-bold text-sm">${h.reward}</div>
                        </div>
                    `;
                });
            }

            document.getElementById('stats-modal').classList.add('active');
        };

        // --- NEW RAFFLE LOGIC ---
        function openBulkModal() { document.getElementById('bulk-modal').classList.add('active'); document.getElementById('bulk-input').focus(); }
        function closeBulkModal() { document.getElementById('bulk-modal').classList.remove('active'); }
        
        function toggleRaffleJoin(e) { 
            state.isRaffleJoinEnabled = e; 
            document.getElementById('raffle-start-btn').classList.toggle('hidden', e); 
            document.getElementById('raffle-stop-btn').classList.toggle('hidden', !e);
            if(window.updateFirestoreGameState) window.updateFirestoreGameState('raffle', e ? 'open' : 'closed');
        }

        function processBulkAdd() {
            const raw = document.getElementById('bulk-input').value;
            if(!raw.trim()) return closeBulkModal();
            const names = raw.split('\n').map(n => n.trim()).filter(n => n !== "");
            names.forEach(name => {
                state.raffleUsers.push({ id: Date.now() + Math.random(), name: name });
            });
            updateRaffleUserList();
            document.getElementById('bulk-input').value = "";
            closeBulkModal();
        }

        window.updateRaffleUserList = function() {
            document.getElementById('raffle-user-count').innerText = state.raffleUsers.length;
            const list = document.getElementById('raffle-user-list');
            list.innerHTML = '';
            state.raffleUsers.forEach(u => {
                const isE = state.eliminatedRaffleUsers.includes(u.id);
                list.innerHTML += `<div class="p-2 bg-slate-800 rounded-lg text-[20px] font-bold transition-opacity duration-1000 ${isE?'opacity-20 user-winner':''}">${u.name}</div>`;
            });
        }

        function startBulkRaffleLoop() {
            if(state.isRaffleRunning) return;
            const drawCount = parseInt(document.getElementById('raffle-draw-count').value) || 1;
            const rewardName = document.getElementById('raffle-reward-name').value || "√ñd√ºl";
            const available = state.raffleUsers.filter(u => !state.eliminatedRaffleUsers.includes(u.id));
            if(available.length === 0) return alert("√áekili≈ü yapacak uygun katƒ±lƒ±mcƒ± kalmadƒ±!");
            if(available.length < drawCount) return alert(`Yeterli katƒ±lƒ±mcƒ± yok! (Mevcut: ${available.length}, ƒ∞stenen: ${drawCount})`);

            if(window.batchUpdateParticipation) window.batchUpdateParticipation(available);

            state.isRaffleRunning = true;
            document.getElementById('start-raffle-btn').classList.add('opacity-50', 'cursor-not-allowed');
            document.getElementById('raffle-status-msg').classList.remove('opacity-0');
            document.getElementById('raffle-results-grid').innerHTML = '';

            let winnersFound = 0;

            function pickWinner() {
                const currentPool = state.raffleUsers.filter(u => !state.eliminatedRaffleUsers.includes(u.id));
                if(currentPool.length === 0 || winnersFound >= drawCount) {
                    finishRaffle();
                    return;
                }

                const winner = currentPool[Math.floor(Math.random() * currentPool.length)];
                state.eliminatedRaffleUsers.push(winner.id);
                winnersFound++;
                saveToArchive(winner.name, "√áEKƒ∞Lƒ∞≈û", `${drawCount} Ki≈üilik`, rewardName, winner.race);

                window.updateRaffleUserList();

                const grid = document.getElementById('raffle-results-grid');
                const cardHTML = `
                    <div class="raffle-luxury-card">
                        <div class="shimmer-layer"></div>
                        <div class="raffle-rank-badge">${winnersFound}</div>
                        <div class="raffle-info">
                            <h4>TALƒ∞HLƒ∞ KAZANAN</h4>
                            <div class="winner-name">${winner.name}</div>
                            <div class="reward-tag">
                                <span>‚ú¶</span> ${rewardName}
                            </div>
                        </div>
                    </div>
                `;
                
                grid.insertAdjacentHTML('beforeend', cardHTML);
                if(winnersFound < drawCount) { setTimeout(pickWinner, 3000); } else { setTimeout(finishRaffle, 1000); }
            }
            pickWinner();
        }

        function finishRaffle() {
            state.isRaffleRunning = false;
            document.getElementById('start-raffle-btn').classList.remove('opacity-50', 'cursor-not-allowed');
            document.getElementById('raffle-status-msg').classList.add('opacity-0');
            alert("√áekili≈ü tamamlandƒ±!");
        }

        // --- MIRROR LOGIC ---
        function toggleMirrorJoin(e) { 
            state.isMirrorJoinEnabled = e; 
            document.getElementById('mirror-start-btn').classList.toggle('hidden', e); 
            document.getElementById('mirror-stop-btn').classList.toggle('hidden', !e);
            if(window.updateFirestoreGameState) window.updateFirestoreGameState('mirror', e ? 'open' : 'closed');
        }
        window.updateMirrorUserList = function(activeId) { document.getElementById('mirror-user-count').innerText = state.mirrorUsers.length; const list = document.getElementById('mirror-user-list'); list.innerHTML = ''; state.mirrorUsers.forEach(u => { const isE = state.eliminatedMirrorUsers.includes(u.id); list.innerHTML += `<div class="p-2 bg-slate-800 rounded-lg text-[20px] font-bold ${isE?'opacity-30 user-winner':''} ${activeId===u.id?'ring-1 ring-purple-400':''}">${u.name}</div>`; }); }
        
        function createMirrorGrid() { 
            const grid = document.getElementById('mirror-grid'); grid.innerHTML = ''; 
            let vals = [...Array(3).fill(5), ...Array(5).fill(2), ...Array(7).fill(1)]; 
            state.mirrorValues = vals.sort(() => Math.random() - 0.5); 
            state.mirrorSelectionIndices = [];
            for(let i=1; i<=state.mirrorCount; i++) { 
                const val = state.mirrorValues[i-1];
                grid.innerHTML += `<div class="mirror-wrapper"><div id="mirror-card-${i}" onclick="handleMirrorClick(${i})" class="mirror-card"><div class="mirror-front">${i}</div><div class="mirror-back val-${val}">${val}</div></div></div>`; 
            } 
        }

        function renderMirrorRewardTable() { 
            const table = document.getElementById('reward-pyramid'); table.innerHTML = ''; 
            const sortedKeys = Object.keys(state.config.mirrorRewardsMap).sort((a,b) => parseInt(b)-parseInt(a)); 
            sortedKeys.forEach(p => {
                table.innerHTML += `<div id="py-item-${p}" class="pyramid-item"><span>${p} PUAN</span><span>${state.config.mirrorRewardsMap[p]}</span></div>`; 
            });
        }

        async function startMirrorRaffle() { 
            const av = state.mirrorUsers.filter(u => !state.eliminatedMirrorUsers.includes(u.id)); 
            if(av.length === 0) return; 
            resetMirrorRound(); 
            let count = 0; 
            const int = setInterval(() => { 
                const p = av[Math.floor(Math.random()*av.length)]; 
                window.updateMirrorUserList(p.id); 
                if(count++ > 20) { 
                    clearInterval(int); 
                    state.mirrorWinner = p; 
                    document.getElementById('mirror-winner-name').innerText = p.name; 
                    document.getElementById('mirror-winner-display').classList.remove('opacity-0'); 
                    updateMirrorSelectionDisplay(); 
                } 
            }, 100); 
        }

        function updateMirrorSelectionDisplay() { document.getElementById('mirror-selection-count').innerText = `HAK: ${3 - state.mirrorSelections} / 3`; }
        
        function handleMirrorClick(n) { 
            if(!state.mirrorWinner || state.mirrorSelections >= 3) return; 
            const card = document.getElementById(`mirror-card-${n}`); 
            if(card.classList.contains('flipped')) return; 
            card.classList.add('flipped'); 
            card.querySelector('.mirror-back').classList.add('selected-mirror');
            state.mirrorSelections++; 
            state.mirrorSelectionIndices.push(n);
            state.mirrorCurrentTotal += state.mirrorValues[n-1]; 
            document.getElementById('mirror-total-score').innerText = state.mirrorCurrentTotal; 
            document.getElementById('mirror-total-score-panel').classList.remove('opacity-0'); 
            updateMirrorSelectionDisplay(); 
            if(state.mirrorSelections === 3) finishMirrorRound(); 
        }

        function finishMirrorRound() { 
            const total = state.mirrorCurrentTotal; 
            const reward = state.config.mirrorRewardsMap[total] || "√ñd√ºl Yok"; 
            document.querySelectorAll('.mirror-card').forEach(c => c.classList.add('flipped'));
            document.querySelectorAll('.pyramid-item').forEach(i => i.classList.remove('highlight')); 
            const highlightEl = document.getElementById(`py-item-${total}`); 
            if(highlightEl) highlightEl.classList.add('highlight'); 
            document.getElementById('mirror-reward-text').innerText = reward; 
            document.getElementById('mirror-result-announcement').classList.remove('opacity-0', 'translate-y-4'); 
            saveToArchive(state.mirrorWinner.name, "AYNA", `${total} Puan`, reward, state.mirrorWinner.race); 
            
            if(window.batchUpdateParticipation) window.batchUpdateParticipation(state.mirrorUsers);

            state.eliminatedMirrorUsers.push(state.mirrorWinner.id); 
            window.updateMirrorUserList(); 
        }

        function resetMirrorRound() { 
            state.mirrorWinner = null; state.mirrorSelections = 0; state.mirrorCurrentTotal = 0; 
            document.getElementById('mirror-winner-display').classList.add('opacity-0'); 
            document.getElementById('mirror-total-score-panel').classList.add('opacity-0'); 
            document.getElementById('mirror-result-announcement').classList.add('opacity-0'); 
            document.getElementById('mirror-total-score').innerText = "0"; 
            document.querySelectorAll('.pyramid-item').forEach(i => i.classList.remove('highlight')); 
            createMirrorGrid(); 
        }

        // --- TICKET GAME LOGIC ---
        function toggleTicketJoin(e) {
            state.isTicketJoinEnabled = e;
            document.getElementById('ticket-start-btn').classList.toggle('hidden', e);
            document.getElementById('ticket-stop-btn').classList.toggle('hidden', !e);
            if(window.updateFirestoreGameState) window.updateFirestoreGameState('ticket', e ? 'open' : 'closed');
        }

        window.updateTicketUserList = function() {
            document.getElementById('ticket-user-count').innerText = state.ticketUsers.length;
            const list = document.getElementById('ticket-user-list');
            list.innerHTML = '';
            state.ticketUsers.forEach(u => {
                list.innerHTML += `<div class="p-2 bg-amber-900/20 border border-amber-500/20 rounded-lg flex justify-between items-center text-[20px] font-bold"><span>${u.name}</span><span class="font-mono text-amber-400 tracking-widest text-[20px]">${u.ticketNumber}</span></div>`;
            });
        }

        function startTicketDraw() {
            if (state.ticketUsers.length === 0) return alert("Bilet alan oyuncu yok!");
            if(window.batchUpdateParticipation) window.batchUpdateParticipation(state.ticketUsers);

            const winner = state.ticketUsers[Math.floor(Math.random() * state.ticketUsers.length)];
            state.ticketWinner = winner;
            const winningNumbers = winner.ticketNumber.split('');

            document.getElementById('ticket-winner-area').classList.add('opacity-0', 'translate-y-10');
            document.getElementById('reveal-winner-btn').classList.add('hidden');
            for(let i=1; i<=5; i++) {
                const ball = document.getElementById(`ticket-ball-${i}`);
                ball.innerText = "?";
                ball.classList.remove('active');
            }
            winningNumbers.forEach((num, index) => {
                setTimeout(() => {
                    const ball = document.getElementById(`ticket-ball-${index+1}`);
                    ball.innerText = num;
                    ball.classList.add('active');
                }, (index + 1) * 1000);
            });
            setTimeout(() => { document.getElementById('reveal-winner-btn').classList.remove('hidden'); }, 6000);
        }

        function revealTicketWinner() {
            if (!state.ticketWinner) return;
            const wName = state.ticketWinner.name;
            document.getElementById('ticket-winner-name').innerText = wName;
            document.getElementById('ticket-winner-area').classList.remove('opacity-0', 'translate-y-10');
            document.getElementById('reveal-winner-btn').classList.add('hidden');
            fireConfetti();
            saveToArchive(wName, "Bƒ∞LET", `No: ${state.ticketWinner.ticketNumber}`, "B√ºy√ºk ƒ∞kramiye", state.ticketWinner.race);
        }

        // --- BOX LOGIC ---
        function toggleJoin(e) { 
            state.isJoinEnabled = e; 
            document.getElementById('start-btn').classList.toggle('hidden', e); 
            document.getElementById('stop-btn').classList.toggle('hidden', !e);
            if(window.updateFirestoreGameState) window.updateFirestoreGameState('game', e ? 'open' : 'closed');
        }
        window.updateUserList = function(a) { 
            document.getElementById('user-count').innerText = state.users.length; 
            const list = document.getElementById('user-list'); 
            list.innerHTML = ''; 
            state.users.forEach(u => { 
                const isE = state.eliminatedUsers.includes(u.id); 
                list.innerHTML += `<div class="p-2 bg-slate-800 rounded-lg text-[20px] font-bold ${isE?'opacity-30 user-winner':''} ${a===u.id?'ring-1 ring-sky-400':''}">${u.name}</div>`; 
            }); 
        }
        
        function shuffleRewards() { state.boxRewards = [...state.config.rewards].sort(() => Math.random() - 0.5); }
        function createBoxes(c) { const g = document.getElementById('box-grid'); g.innerHTML = ''; g.className = "grid grid-cols-2 md:grid-cols-5 gap-2"; for(let i=1;i<=c;i++) { g.innerHTML += `<div id="box-${i}" onclick="handleBoxClick(${i})" class="box-item"><div class="box-inner"><div class="box-front"><div class="box-number-badge">${i}</div><span class="box-icon">üéÅ</span></div><div class="box-back"><div id="reward-text-${i}" class="text-[10px] text-center p-1 font-bold text-sky-400"></div></div></div></div>`; } }
        
        function handleBoxClick(n) { 
            if(!state.currentWinner || state.isBoxOpened) return; 
            const rawReward = state.boxRewards[n-1] || "Pas"; 
            let rewardText = rawReward;
            let rewardImg = null;
            if (rawReward.includes('|')) {
                const parts = rawReward.split('|');
                rewardText = parts[0].trim();
                rewardImg = parts[1].trim();
            }
            state.isBoxOpened = true; 
            state.eliminatedUsers.push(state.currentWinner.id); 
            document.getElementById(`box-${n}`).classList.add('opened'); 
            const contentHTML = rewardImg ? `<div class="flex flex-col items-center justify-center w-full h-full"><img src="${rewardImg}" class="w-12 h-12 object-contain mb-1 shadow-lg rounded-md"><span class="text-[10px] leading-tight text-white">${rewardText}</span></div>` : rewardText;
            document.getElementById(`reward-text-${n}`).innerHTML = contentHTML; 
            document.getElementById('post-box-controls').classList.remove('opacity-0', 'pointer-events-none'); 
            
            if(window.batchUpdateParticipation) window.batchUpdateParticipation(state.users);
            
            saveToArchive(state.currentWinner.name, "KUTU", `#${n}`, rewardText, state.currentWinner.race); 
        }

        function nextRound() { state.currentWinner = null; state.isBoxOpened = false; document.getElementById('winner-banner').classList.add('opacity-0'); document.getElementById('post-box-controls').classList.add('opacity-0', 'pointer-events-none'); window.updateUserList(); }
        async function startRaffle() { const av = state.users.filter(u => !state.eliminatedUsers.includes(u.id)); if(av.length===0) return; let count = 0; const int = setInterval(() => { const p = av[Math.floor(Math.random()*av.length)]; window.updateUserList(p.id); if(count++ > 20) { clearInterval(int); state.currentWinner = p; document.getElementById('winner-name').innerText = p.name; document.getElementById('winner-banner').classList.remove('opacity-0'); } }, 100); }

        // --- WHEEL LOGIC ---
        function toggleWheelJoin(e) { 
            state.isWheelJoinEnabled = e; 
            document.getElementById('wheel-start-btn').classList.toggle('hidden', e); 
            document.getElementById('wheel-stop-btn').classList.toggle('hidden', !e);
            if(window.updateFirestoreGameState) window.updateFirestoreGameState('wheel', e ? 'open' : 'closed');
        }
        window.updateWheelUserList = function(activeId) { document.getElementById('wheel-user-count').innerText = state.wheelUsers.length; const list = document.getElementById('wheel-user-list'); list.innerHTML = ''; state.wheelUsers.forEach(u => { const isE = state.eliminatedWheelUsers.includes(u.id); list.innerHTML += `<div class="p-2 bg-slate-800 rounded-lg text-[20px] font-bold ${isE?'opacity-30 user-winner':''} ${activeId===u.id?'ring-1 ring-emerald-400':''}">${u.name}</div>`; }); }
        
        async function startWheelRaffle() { const av = state.wheelUsers.filter(u => !state.eliminatedWheelUsers.includes(u.id)); if(av.length === 0) return; let count = 0; const int = setInterval(() => { const p = av[Math.floor(Math.random()*av.length)]; window.updateWheelUserList(p.id); if(count++ > 20) { clearInterval(int); state.wheelWinner = p; document.getElementById('wheel-winner-name').innerText = p.name; document.getElementById('wheel-winner-reward').classList.add('opacity-0'); document.getElementById('wheel-winner-banner').classList.remove('opacity-0'); } }, 100); }
        function drawWheel() { 
            const canvas = document.getElementById('wheel-canvas'); 
            if(!canvas) return; 
            const ctx = canvas.getContext('2d'); 
            const rw = state.config.wheelRewards; 
            const center = canvas.width / 2; 
            const radius = center - 15; 
            ctx.clearRect(0,0,canvas.width,canvas.height); 
            if(rw.length===0) return; 
            const slice = (Math.PI*2)/rw.length; 
            rw.forEach((r, i) => { 
                ctx.save(); 
                ctx.translate(center,center); 
                ctx.rotate(state.wheelAngle + i*slice); 
                ctx.beginPath(); 
                ctx.moveTo(0,0); 
                ctx.arc(0,0,radius,0,slice); 
                ctx.fillStyle = state.colors[i % state.colors.length]; 
                ctx.fill(); 
                ctx.strokeStyle = "rgba(255,255,255,0.2)"; 
                ctx.lineWidth = 1; 
                ctx.stroke(); 
                ctx.rotate(slice/2); 
                ctx.fillStyle="white"; 
                ctx.textAlign = "right"; 
                ctx.font="bold 14px Rajdhani"; 
                
                let displayText = r;
                if(r.includes('|')) {
                    displayText = r.split('|')[0].trim();
                }
                ctx.fillText(displayText.substring(0,15), radius - 30, 5); 
                
                ctx.restore(); 
            }); 
            ctx.beginPath(); 
            ctx.arc(center,center,20,0,Math.PI*2); 
            ctx.fillStyle="#fff"; 
            ctx.fill(); 
        }
        
        function spinWheel() { 
            if(state.isWheelSpinning || !state.wheelWinner) return; 
            if(state.config.wheelRewards.length === 0) return alert("√áarkta daƒüƒ±tƒ±lacak √∂d√ºl kalmadƒ±!");

            if(window.batchUpdateParticipation) window.batchUpdateParticipation(state.wheelUsers);

            state.isWheelSpinning = true; 
            const spinRounds = 10 + Math.random() * 5; 
            const targetAngle = state.wheelAngle + (Math.PI * 2 * spinRounds); 
            const startAngle = state.wheelAngle; 
            const duration = 6000; 
            const startTime = performance.now(); 
            
            const anim = (now) => { 
                const elapsed = now - startTime; 
                const t = Math.min(elapsed / duration, 1); 
                const easeOut = 1 - Math.pow(1 - t, 4); 
                state.wheelAngle = startAngle + (targetAngle - startAngle) * easeOut; 
                drawWheel(); 
                
                if(t < 1) requestAnimationFrame(anim); 
                else { 
                    state.isWheelSpinning = false; 
                    const rw = state.config.wheelRewards; 
                    const slice = (Math.PI*2)/rw.length; 
                    const offset = (Math.PI * 1.5); 
                    const normalized = (offset - state.wheelAngle) % (Math.PI * 2); 
                    const finalNorm = normalized < 0 ? normalized + (Math.PI * 2) : normalized; 
                    const index = Math.floor(finalNorm / slice); 
                    const result = rw[index]; 
                    
                    let rewardText = result;
                    let rewardImg = null;
                    if (result.includes('|')) {
                        const parts = result.split('|');
                        rewardText = parts[0].trim();
                        rewardImg = parts[1].trim();
                    }
                    
                    const rewardEl = document.getElementById('wheel-winner-reward'); 
                    
                    if (rewardImg) {
                        rewardEl.innerHTML = `
                            <div class="flex flex-col items-center animate-bounce">
                                <span class="text-[10px] text-slate-400 mb-1">KAZANILAN √ñD√úL</span>
                                <img src="${rewardImg}" class="w-32 h-32 object-contain mb-2 rounded-xl shadow-[0_0_20px_rgba(250,204,21,0.3)] bg-slate-900/50 border border-yellow-500/30">
                                <span class="text-3xl text-yellow-400 drop-shadow-md">${rewardText}</span>
                            </div>
                        `;
                    } else {
                        rewardEl.innerHTML = `
                             <div class="flex flex-col items-center">
                                <span class="text-[10px] text-slate-400 mb-1">KAZANILAN √ñD√úL</span>
                                <span class="text-3xl text-yellow-400 drop-shadow-md">${rewardText}</span>
                            </div>
                        `;
                    }
                    
                    rewardEl.classList.remove('opacity-0', 'translate-y-2'); 
                    
                    saveToArchive(state.wheelWinner.name, "√áARK", "√ñd√ºl", rewardText, state.wheelWinner.race); 
                    state.eliminatedWheelUsers.push(state.wheelWinner.id); 
                    
                    setTimeout(() => {
                        state.config.wheelRewards.splice(index, 1);
                        drawWheel(); 
                        state.wheelWinner = null; 
                        document.getElementById('wheel-winner-banner').classList.add('opacity-0'); 
                        window.updateWheelUserList(); 
                    }, 6000); 
                } 
            }; 
            requestAnimationFrame(anim); 
        }

        // --- LUCKY BALLS LOGIC ---
        function toggleLuckyJoin(e) { 
            state.isLuckyJoinEnabled = e; 
            document.getElementById('lucky-start-btn').classList.toggle('hidden', e); 
            document.getElementById('lucky-stop-btn').classList.toggle('hidden', !e);
            if(window.updateFirestoreGameState) window.updateFirestoreGameState('lucky', e ? 'open' : 'closed');
        }
        window.updateLuckyUserList = function() { document.getElementById('lucky-user-count').innerText = state.luckyUsers.length; const list = document.getElementById('lucky-user-list'); list.innerHTML = ''; state.luckyUsers.forEach(u => { const isW = state.luckyWinnersIds.includes(u.id); list.innerHTML += `<div class="p-2 bg-yellow-900/10 border border-yellow-500/10 rounded-lg flex justify-between items-center text-[20px] font-bold ${isW?'user-winner ring-1 ring-yellow-400':''}"><span>${u.name}</span><span class="text-yellow-500 font-mono tracking-widest">${u.numbers.join('-')}</span></div>`; }); }
        
        function rollLuckyBalls() { if(state.isLuckyRolling || state.luckyUsers.length === 0) return; state.isLuckyRolling = true; document.getElementById('lucky-result-panel').classList.add('opacity-0', 'translate-y-4'); const balls = [document.getElementById('ball-1'), document.getElementById('ball-2'), document.getElementById('ball-3')]; const res = [Math.floor(Math.random()*9)+1, Math.floor(Math.random()*9)+1, Math.floor(Math.random()*9)+1]; balls.forEach(b => b.classList.add('ball-spinning')); let fin = 0; balls.forEach((b, i) => { let cyc = 0; const max = 20 + (i * 15); const int = setInterval(() => { b.innerText = Math.floor(Math.random()*9)+1; if(cyc++ >= max) { clearInterval(int); b.innerText = res[i]; b.classList.remove('ball-spinning'); fin++; if(fin === balls.length) { state.luckyResult = res; processLuckyWinners(); } } }, 60); }); }

        function processLuckyWinners() { 
            state.isLuckyRolling = false; 
            const [r1, r2, r3] = state.luckyResult;
            
            if(window.batchUpdateParticipation) window.batchUpdateParticipation(state.luckyUsers);

            const winners3 = state.luckyUsers.filter(u => u.numbers[0] === r1 && u.numbers[1] === r2 && u.numbers[2] === r3);
            const winners2 = state.luckyUsers.filter(u => u.numbers[0] === r1 && u.numbers[1] === r2 && u.numbers[2] !== r3);
            const winners1 = state.luckyUsers.filter(u => u.numbers[0] === r1 && u.numbers[1] !== r2);

            let winningGroup = [];
            let perPersonReward = 0;
            let groupLabel = "";

            if (winners3.length > 0) {
                winningGroup = winners3;
                perPersonReward = Math.floor(state.config.luckyJackpot / winners3.length);
                groupLabel = "3 Bƒ∞LEN";
            } else if (winners2.length > 0) {
                winningGroup = winners2;
                perPersonReward = Math.floor((state.config.luckyJackpot * 0.5) / winners2.length);
                groupLabel = "2 Bƒ∞LEN";
            } else if (winners1.length > 0) {
                winningGroup = winners1;
                perPersonReward = Math.floor((state.config.luckyJackpot * 0.25) / winners1.length);
                groupLabel = "1 Bƒ∞LEN";
            }

            const d = document.getElementById('lucky-winners-display'); 
            d.innerHTML = ''; 

            if(winningGroup.length > 0) {
                state.luckyWinnersIds.push(...winningGroup.map(u => u.id));
                winningGroup.forEach(w => {
                    d.innerHTML += `<div class="flex justify-between items-center p-3 bg-emerald-500/20 border border-emerald-500/40 rounded-xl">
                        <span class="font-black text-white">${w.name}</span>
                        <div class="text-right">
                            <div class="text-[9px] text-slate-400 uppercase font-bold">${groupLabel}</div>
                            <div class="text-emerald-400 font-bold">${perPersonReward.toLocaleString()} ALTIN</div>
                        </div>
                    </div>`;
                    saveToArchive(w.name, "≈ûANS TOPU", groupLabel, `${perPersonReward} Altƒ±n`, w.race);
                });
                document.getElementById('lucky-final-announcement').innerText = "KAZANANLAR VAR!";
            } else {
                d.innerHTML = `<div class="text-center p-8 text-slate-500 font-bold italic uppercase tracking-widest">BU TURDA KAZANAN OLMADI</div>`;
                document.getElementById('lucky-final-announcement').innerText = "Kƒ∞MSE Bƒ∞LEMEDƒ∞...";
            }
            window.updateLuckyUserList();
            document.getElementById('lucky-result-panel').classList.remove('opacity-0', 'translate-y-4');
        }

        // --- DICE LOGIC ---
        function toggleDiceJoin(e) { 
            state.isDiceJoinEnabled = e; 
            document.getElementById('dice-start-btn').classList.toggle('hidden', e); 
            document.getElementById('dice-stop-btn').classList.toggle('hidden', !e);
            if(window.updateFirestoreGameState) window.updateFirestoreGameState('dice', e ? 'open' : 'closed');
        }
        window.updateDiceUserList = function() { document.getElementById('dice-user-count').innerText = state.diceUsers.length; const list = document.getElementById('dice-user-list'); list.innerHTML = ''; state.diceUsers.forEach(u => { const isW = state.diceWinnersIds.includes(u.id); list.innerHTML += `<div class="p-2 bg-indigo-900/10 border border-indigo-500/10 rounded-lg flex justify-between items-center text-[20px] font-bold ${isW?'user-winner ring-1 ring-indigo-400':''}"><span>${u.name}</span><span class="text-indigo-400 font-mono tracking-widest">/zar ${u.target}</span></div>`; }); }
        
        function renderDiceDots(el, num) { if(!el) return; el.innerHTML = ''; const p = { 1:[4], 2:[0,8], 3:[0,4,8], 4:[0,2,6,8], 5:[0,2,4,6,8], 6:[0,2,3,5,6,8] }; const dots = p[num] || []; for(let i=0; i<9; i++) { const d = document.createElement('div'); if(dots.includes(i)) d.className = 'dice-dot'; el.appendChild(d); } }
        function rollDice() { if(state.isDiceRolling || state.diceUsers.length === 0) return; state.isDiceRolling = true; document.getElementById('dice-result-panel').classList.add('opacity-0', 'translate-y-4'); const res = [1,2,3,4,5].map(() => Math.floor(Math.random()*6)+1); const sum = res.reduce((a,b)=>a+b, 0); const diceEls = [1,2,3,4,5].map(i => document.getElementById(`dice-${i}`)); diceEls.forEach(d => d.classList.add('dice-rolling')); let fin = 0; diceEls.forEach((d, i) => { let cyc = 0; const max = 15 + (i * 8); const int = setInterval(() => { renderDiceDots(d, Math.floor(Math.random()*6)+1); if(cyc++ >= max) { clearInterval(int); renderDiceDots(d, res[i]); d.classList.remove('dice-rolling'); fin++; if(fin === 5) { state.diceSum = sum; processDiceWinners(); } } }, 80); }); }

        function processDiceWinners() { 
            state.isDiceRolling = false; 
            document.getElementById('dice-sum').innerText = state.diceSum; 
            document.getElementById('dice-total-display').classList.remove('opacity-0'); 
            
            if(window.batchUpdateParticipation) window.batchUpdateParticipation(state.diceUsers);

            const winners = state.diceUsers.filter(u => u.target === state.diceSum); 
            const d = document.getElementById('dice-winners-display'); 
            d.innerHTML = ''; 

            if(winners.length > 0) {
                const perPersonReward = Math.floor(state.config.diceJackpot / winners.length);
                state.diceWinnersIds.push(...winners.map(u => u.id));
                winners.forEach(w => {
                    d.innerHTML += `<div class="flex justify-between items-center p-3 bg-indigo-500/20 border border-indigo-500/40 rounded-xl">
                        <span class="font-black text-white">${w.name}</span>
                        <div class="text-right">
                            <div class="text-[9px] text-slate-400 uppercase font-bold">TAM ƒ∞SABET</div>
                            <div class="text-indigo-400 font-bold">${perPersonReward.toLocaleString()} ALTIN</div>
                        </div>
                    </div>`;
                    saveToArchive(w.name, "ZAR", `Tahmin: ${state.diceSum}`, `${perPersonReward} Altƒ±n`, w.race);
                });
                document.getElementById('dice-final-announcement').innerText = "√ñD√úLLER DAƒûITILDI!";
            } else {
                d.innerHTML = `<div class="text-center p-8 text-slate-500 font-bold italic uppercase tracking-widest">Kƒ∞MSE Bƒ∞LEMEDƒ∞</div>`;
                document.getElementById('dice-final-announcement').innerText = "Kƒ∞MSE Bƒ∞LEMEDƒ∞...";
            }
            window.updateDiceUserList();
            document.getElementById('dice-result-panel').classList.remove('opacity-0', 'translate-y-4');
        }

        // --- UTILS ---
        function saveToArchive(n, t, d, r, race) { 
            state.winners.push({ name: n, type: t, detail: d, reward: r, time: new Date().toLocaleTimeString() }); 
            
            if(window.updateStatInFirestore) {
                window.updateStatInFirestore(n, true, { game: t, detail: d, reward: r }, race);
            }
        }
        function updateMarquee() { const marquee = document.getElementById('marquee'); if (state.winners.length > 0) { const latest = state.winners.slice(-8); marquee.innerHTML = latest.map(w => `<span class="flex items-center gap-2"><b class="text-white">${w.name}</b> <span class="text-sky-400 font-bold italic">${w.type}</span> <b class="text-yellow-400 uppercase">${w.reward}</b> <span class="text-white/20">|</span></span>`).join(''); } }
        function renderLargeWinnersList() { const l = document.getElementById('winners-log-large'); l.innerHTML = ''; [...state.winners].reverse().forEach(w => { l.innerHTML += `<div class="p-3 bg-white/5 rounded-lg text-xs grid grid-cols-4"><span>${w.time}</span><span class="text-sky-400 font-bold">${w.type}</span><span>${w.name}</span><span class="text-yellow-500 font-bold">${w.reward}</span></div>`; }); }
        
        function exportWinners() {
            if (state.winners.length === 0) return alert("Dƒ±≈üa aktarƒ±lacak veri yok!");
            const grouped = {};
            state.winners.forEach(w => {
                const reward = w.reward || "Bilinmeyen √ñd√ºl";
                if (!grouped[reward]) grouped[reward] = [];
                grouped[reward].push(w.name);
            });
            let textContent = "DWAR ETKƒ∞NLƒ∞K MERKEZƒ∞ - KAZANANLAR Lƒ∞STESƒ∞\n";
            textContent += "Tarih: " + new Date().toLocaleString() + "\n";
            textContent += "==========================================\n\n";
            for (const [reward, names] of Object.entries(grouped)) {
                textContent += `>>> √ñD√úL: ${reward} <<<\n`;
                textContent += `------------------------------------------\n`;
                names.forEach((name, index) => { textContent += `${index + 1}. ${name}\n`; });
                textContent += `\n`; 
            }
            const blob = new Blob([textContent], { type: 'text/plain;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.setAttribute("href", url);
            link.setAttribute("download", "kazananlar_gruplandirilmis.txt");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function confirmReset() { 
            if(confirm("Dƒ∞KKAT: Bu i≈ülem t√ºm katƒ±lƒ±mcƒ± listelerini veritabanƒ±ndan silecek ve ekranƒ± temizleyecektir. Oturum kapanmayacaktƒ±r. Devam edilsin mi?")) { 
                window.fullSystemReset();
            } 
        }

        // CONFETTI FUNC
        function fireConfetti() {
            const canvas = document.getElementById("confetti-canvas");
            const ctx = canvas.getContext("2d");
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            const particles = [];
            for (let i = 0; i < 300; i++) {
                particles.push({
                    x: Math.random() * canvas.width,
                    y: Math.random() * canvas.height - canvas.height,
                    vx: Math.random() * 4 - 2,
                    vy: Math.random() * 4 + 2,
                    color: `hsl(${Math.random() * 360}, 100%, 50%)`,
                    size: Math.random() * 6 + 2
                });
            }
            function animate() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                let active = false;
                particles.forEach(p => {
                    p.x += p.vx;
                    p.y += p.vy;
                    if (p.y < canvas.height) active = true;
                    ctx.fillStyle = p.color;
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
                    ctx.fill();
                });
                if (active) requestAnimationFrame(animate);
                else ctx.clearRect(0,0,canvas.width,canvas.height);
            }
            animate();
        }

        window.onload = init;
    </script>
</body>
</html>