<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>Player Panel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-900 text-white flex items-center justify-center min-h-screen">

<div id="app" class="w-full max-w-md p-6 bg-slate-800 rounded-xl text-center">
  <h1 class="text-2xl font-bold mb-4">Oyuncu Paneli</h1>

  <div id="status" class="text-slate-400 mb-4">
    BaÄŸlanÄ±yor...
  </div>

  <div id="register" class="hidden space-y-3">
    <input id="nick" placeholder="Nick" class="w-full p-3 rounded bg-slate-700" />
    <button id="joinBtn" class="w-full bg-green-600 py-3 rounded font-bold">
      KatÄ±l
    </button>
  </div>

  <div id="success" class="hidden text-green-400 font-bold">
    KatÄ±lÄ±m alÄ±ndÄ± âœ”
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
  import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
  import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

  // ğŸ”¥ AYNI FIREBASE (ADMIN Ä°LE AYNI)
  const firebaseConfig = {
    apiKey: "AIzaSyA4yI7eN3DF-Kt4HSuwt6hpZzI4Z8s2PN0",
    authDomain: "dwar-etkinlik-merkezi-15d51.firebaseapp.com",
    projectId: "dwar-etkinlik-merkezi-15d51",
    storageBucket: "dwar-etkinlik-merkezi-15d51.firebasestorage.app",
    messagingSenderId: "262902378690",
    appId: "1:262902378690:web:76a68a16e0d9e6c5e44b5b"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const statusEl = document.getElementById("status");
  const registerEl = document.getElementById("register");
  const successEl = document.getElementById("success");
  const joinBtn = document.getElementById("joinBtn");
  const nickInput = document.getElementById("nick");

  let currentUser = null;
  let activeState = null;

  // ğŸ” ANON LOGIN
  signInAnonymously(auth).then((cred) => {
    currentUser = cred.user;
    listenState();
  });

  // ğŸ‘‚ ADMIN STATE DÄ°NLE
  function listenState() {
    const stateRef = doc(db, "artifacts", "default", "public", "data", "active", "state");

    onSnapshot(stateRef, (snap) => {
      if (!snap.exists()) {
        statusEl.innerText = "â³ YÃ¶netici henÃ¼z oyun aÃ§madÄ±";
        registerEl.classList.add("hidden");
        return;
      }

      activeState = snap.data();

      if (activeState.status !== "open") {
        statusEl.innerText = "â›” Oyun kapalÄ±";
        registerEl.classList.add("hidden");
        return;
      }

      statusEl.innerText = "ğŸŸ¢ Oyun aÃ§Ä±k, katÄ±labilirsin";
      registerEl.classList.remove("hidden");
    });
  }

  // âœï¸ KATILIM
  joinBtn.onclick = async () => {
    const nick = nickInput.value.trim();
    if (!nick) return alert("Nick gir");

    await setDoc(
      doc(db, "artifacts", "default", "public", "data", "entries", `${activeState.round}_${nick}`),
      {
        nick,
        round: activeState.round,
        time: Date.now()
      }
    );

    registerEl.classList.add("hidden");
    successEl.classList.remove("hidden");
    statusEl.innerText = "âœ… KatÄ±ldÄ±n";
  };
</script>
</body>
</html>
